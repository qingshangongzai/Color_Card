# 配色预览功能完善计划

## 功能概述

配色预览功能允许用户在独立的预览面板中查看收藏的配色方案在不同场景下的应用效果。该功能已初步实现，但存在一些需要完善的问题。

---

## 已实现功能

### 1. 基础组件
- **DraggableColorDot**: 可拖拽的颜色圆点组件
- **ColorDotBar**: 颜色圆点工具栏，支持拖拽排序
- **IllustrationPreview**: 插画风格预览（使用 QPainter 绘制植物风格矢量图）
- **TypographyPreview**: 排版风格预览（展示文字排版效果）
- **PreviewToolbar**: 预览工具栏（包含圆点栏和场景选择器）
- **MixedPreviewPanel**: Mixed场景预览面板（2x2小图 + 右侧大图）

### 2. 界面集成
- **ColorPreviewInterface**: 配色预览主界面
- 已集成到主窗口导航栏
- 支持从色彩管理页面跳转

### 3. 联动功能
- 色彩管理页面每个配色方案卡片添加了"预览"按钮
- 点击后自动跳转到配色预览页面并加载对应配色
- 支持实时刷新收藏列表

---

## 已知问题

### 问题1：拖拽排序功能异常

**现象描述：**
- 颜色圆点可以拖动
- 但无法正确切换排序位置
- 拖拽结束后圆点顺序没有按预期改变

**可能原因：**
1. `ColorDotBar._calculate_new_index()` 方法计算新索引的逻辑有误
2. 拖拽结束后的位置计算可能基于错误坐标系
3. 重建圆点时索引更新可能存在问题

**相关代码位置：**
```python
# ui/preview_widgets.py - ColorDotBar 类
- _on_drag_ended() 方法
- _calculate_new_index() 方法
- _rebuild_dots() 方法
```

**建议修复方案：**
1. 检查 `_calculate_new_index()` 中的坐标计算逻辑
2. 使用全局坐标而非局部坐标计算拖拽位置
3. 添加调试日志跟踪拖拽过程中的坐标值
4. 考虑使用 Qt 的拖拽框架替代自定义实现

---

### 问题2：预览场景切换未实现

**现象描述：**
- 场景选择器（Mixed/UI/Web/Brand/Illustration/排版/海报/图案）已显示
- 但切换场景后预览内容没有变化
- 目前始终显示 Mixed 场景

---

### 问题3：右键菜单功能缺失

**现象描述：**
- 右键点击颜色圆点无响应
- 无法快速查看颜色详细信息
- 无法通过右键菜单进行删除等操作

**相关代码位置：**
```python
# ui/preview_widgets.py
- DraggableColorDot 类
- ColorDotBar 类
```

**建议修复方案：**
1. 在 `DraggableColorDot` 上实现 `contextMenuEvent` 方法
2. 创建自定义右键菜单，包含：
   - 颜色色块预览（大尺寸）
   - 完整色彩信息（HSB、LAB、HEX等）
   - 复制颜色值选项
   - 删除颜色选项
3. 使用 `RoundMenu` 创建 Fluent 风格的右键菜单
4. 确保菜单样式与主题一致

**⚠️ 兼容性说明：**
- 当前已实现点击色块对排序进行更改的功能
- 右键菜单与左键点击功能互不冲突
- 右键菜单提供查看和编辑功能，左键用于排序

---

### 问题4：不支持对单个色彩进行删除

**现象描述：**
- 颜色圆点栏显示当前配色方案的所有颜色
- 用户无法删除不需要的颜色
- 只能查看，无法编辑颜色列表

**可能原因：**
1. `DraggableColorDot` 组件没有提供删除功能
2. `ColorDotBar` 没有实现删除颜色的接口
3. 缺少删除确认机制，防止误操作

**相关代码位置：**
```python
# ui/preview_widgets.py
- DraggableColorDot 类
- ColorDotBar 类
```

**建议修复方案：**
1. 在 `DraggableColorDot` 上添加删除按钮（悬停显示）
2. 或添加右键菜单，提供"删除"选项
3. 在 `ColorDotBar` 中添加 `delete_color(index)` 方法
4. 添加删除确认或撤销功能（可选）
5. 更新预览区域，反映删除后的颜色变化

**⚠️ 兼容性说明：**
- 当前已实现点击色块对排序进行更改的功能
- 在添加删除功能时，需确保与点击排序功能不冲突
- 建议删除按钮采用悬停显示方式，避免与点击事件冲突

**相关代码位置：**
```python
# ui/preview_widgets.py
- PreviewSceneSelector 类
- MixedPreviewPanel 类

# ui/interfaces.py - ColorPreviewInterface 类
- _on_scene_changed() 方法（目前为空实现）
```

**需要实现的场景：**

| 场景 | 预览内容 | 优先级 |
|------|---------|--------|
| Mixed | 2x2插画小图 + 排版大图 | ✅ 已实现 |
| UI Design | UI组件预览（按钮、输入框等） | 高 |
| Web | 网页布局预览 | 高 |
| Brand | Logo和品牌应用预览 | 中 |
| Illustration | 完整插画预览 | 中 |
| Typography | 文字排版预览 | ✅ 已实现 |
| Poster | 海报设计预览 | 低 |
| Pattern | 图案纹理预览 | 低 |

**建议实现方案：**
1. 创建 `UIPreview` 类：绘制模拟的UI组件（按钮、卡片、输入框）
2. 创建 `WebPreview` 类：绘制简化的网页布局（导航栏、内容区）
3. 创建 `BrandPreview` 类：绘制Logo占位符和品牌元素
4. 在 `ColorPreviewInterface` 中使用 `QStackedWidget` 管理不同场景的预览面板
5. 在 `_on_scene_changed()` 方法中切换对应的预览面板

---

## 优化建议

### 1. 拖拽排序优化
- 添加拖拽时的视觉反馈（如半透明效果、占位符）
- 支持动画过渡效果
- 考虑使用 `QDrag` 和 `dropEvent` 标准拖拽机制

### 2. 预览面板优化
- 添加缩放功能，支持查看细节
- 支持导出预览图为图片
- 添加更多预设的插画样式（不仅限于植物）
- **新增 SVG 导入功能**：支持用户导入从 Illustrator 导出的 SVG 插画文件
  - 使用 Qt 的 QSvgRenderer 解析 SVG
  - 支持按 SVG 元素顺序或 ID/class 应用配色
  - 提供示例 SVG 模板，帮助用户理解如何命名元素
  - 完全符合 GPL3 协议（SVG 是开放标准）

### 3. 交互优化
- 在色彩管理页面，预览按钮添加悬停提示
- 配色预览页面添加"返回色彩管理"按钮
- 支持键盘快捷键切换场景
- **支持对单个色彩进行删除**：在颜色圆点上添加删除按钮（悬停显示，避免与点击排序冲突）或右键菜单，允许用户删除不需要的颜色
- **右键点击色块显示详细信息**：右键点击颜色圆点时，弹出包含色块和完整色彩信息（HSB、LAB、HEX等）的菜单，方便用户查看和复制颜色值

### 4. 性能优化
- 缓存绘制好的预览图，避免重复绘制
- 延迟加载非当前场景的预览面板

---

## 文件结构

```
ui/
├── preview_widgets.py          # 预览相关组件
│   ├── DraggableColorDot       # 可拖拽颜色圆点
│   ├── ColorDotBar             # 颜色圆点栏（需要修复拖拽排序）
│   ├── IllustrationPreview     # 插画预览
│   ├── TypographyPreview       # 排版预览
│   ├── PreviewSceneSelector    # 场景选择器
│   ├── MixedPreviewPanel       # Mixed场景面板
│   └── PreviewToolbar          # 预览工具栏
│
├── interfaces.py               # 界面类
│   └── ColorPreviewInterface   # 配色预览界面（需要完善场景切换）
│
├── color_management_widgets.py # 色彩管理组件
│   ├── ColorManagementSchemeCard    # 配色方案卡片（已添加预览按钮）
│   └── ColorManagementSchemeList    # 配色方案列表
│
└── main_window.py              # 主窗口
    └── show_color_preview()    # 跳转到配色预览页面
```

---

## 下一步行动
1. **修复拖拽排序功能**（高优先级）
   - 调试 `ColorDotBar` 类的拖拽逻辑
   - 修复索引计算问题
2. **实现场景切换功能**（高优先级）
   - 创建 `UIPreview` 和 `WebPreview` 类
   - 实现场景切换逻辑
3. **新增 SVG 导入功能**（中优先级）
   - 创建 `SVGPreviewWidget` 类，使用 QSvgRenderer 解析 SVG
   - 实现按 SVG 元素顺序或 ID/class 应用配色
   - 添加导入 SVG 文件的按钮和文件选择对话框
   - 提供示例 SVG 模板文件
5. **实现右键菜单功能**（中优先级）
   - 在 `DraggableColorDot` 上实现 `contextMenuEvent` 方法
   - 创建自定义右键菜单，包含：
     - 颜色色块预览（大尺寸显示）
     - 完整色彩信息（HSB、LAB、HEX等）
     - 复制颜色值选项
     - 删除颜色选项
   - 使用 `RoundMenu` 创建 Fluent 风格的右键菜单
   - 确保菜单样式与主题一致
6. **实现单个色彩删除功能**（中优先级）
   - 在 `DraggableColorDot` 上添加删除按钮（悬停显示）或右键菜单
   - **注意兼容性**：需与已有的点击排序功能协调，避免事件冲突
   - 在 `ColorDotBar` 中实现 `delete_color(index)` 方法
   - 更新预览区域，反映删除后的颜色变化
   - 考虑添加撤销功能（可选）
6. **测试和优化**（中优先级）
   - 测试各种配色数量（2-5色）的显示效果
   - 优化绘制性能

---

## 备注

- 所有修改应遵循项目的开发规范（`文档/开发规范.md`）
- 保持代码风格与现有代码一致
- 添加适当的文档字符串和注释
