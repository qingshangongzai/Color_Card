# 任务 3.6：直方图计算优化计划

## 目标
优化直方图计算性能，将主线程计算改为后台线程异步计算，提升大图片加载体验。

## 当前问题
- 直方图计算在主线程执行，阻塞UI
- 大图片（>4000px）计算耗时 2-3 秒

## 优化方案

### 1. 创建 HistogramCalculator 后台线程
- 文件：`core/histogram_service.py`
- 创建 `HistogramCalculator` 继承 `QThread`
- 支持计算明度直方图、RGB直方图、色相直方图
- 支持采样步长配置（大图片使用更大步长）
- 计算完成后通过信号发射结果

### 2. 创建 HistogramService 服务类
- 管理直方图计算任务生命周期
- 支持取消机制
- 延迟计算（图片显示后延迟 500ms 再开始）
- 通过信号与UI层通信

### 3. 修改 ui/histograms.py
- `LuminanceHistogramWidget`、`RGBHistogramWidget`、`HueHistogramWidget` 使用 `HistogramService`
- `set_image()` 方法改为异步调用
- 添加加载状态显示

### 4. 修改使用直方图的界面类
- 更新 `ColorExtractInterface` 和 `LuminanceExtractInterface`
- 确保图片加载后正确触发直方图计算

## 文件变更清单

### 新增文件
1. `core/histogram_service.py` - 直方图计算服务

### 修改文件
1. `core/__init__.py` - 导出 HistogramService
2. `ui/histograms.py` - 使用异步计算
3. `ui/color_extract.py` - 适配异步直方图
4. `ui/luminance_extract.py` - 适配异步直方图

## 验收标准
- [ ] 直方图计算在后台线程执行
- [ ] 图片显示不阻塞
- [ ] 大图片加载体验明显改善
- [ ] 直方图精度可接受（误差 < 5%）

## 依赖关系
- 依赖任务 3.3（ImageService）已完成
- 依赖任务 3.4（LuminanceService）已完成

## 开发规范遵循
- 遵循 `开发规范.md` 第3.3.1节服务类命名规范
- 遵循 `开发规范.md` 第7.3节 QThread 取消机制
- 遵循 `开发规范.md` 第5.3.1节 ImageMediator 模式
