# 业务服务延迟加载计划

**制定日期**: 2026-02-22
**任务来源**: 重构计划.md 任务 6.1
**目标**: 提升启动性能 50%+

---

## 1. 现状分析

### 1.1 当前服务初始化方式

各 UI 组件在构造时独立创建服务实例：

| UI 组件 | 服务实例 | 创建位置 |
|:---|:---|:---|
| ColorExtractInterface | `ColorService` | `ui/color_extract.py:38` |
| PaletteManagementInterface | `PaletteService` | `ui/palette_management.py:1052` |
| ImageCanvas / LuminanceCanvas | `ImageService` | `ui/canvases.py:64` |
| ImageCanvas / LuminanceCanvas | `LuminanceService` | `ui/canvases.py:65` |

### 1.2 MainWindow 初始化流程

```
main.py:main()
    └── MainWindow.__init__()
            ├── 加载配置
            ├── 创建 ImageMediator
            └── create_sub_interface()
                    ├── ColorExtractInterface()      → 创建 ColorService
                    ├── LuminanceExtractInterface()  → 创建 ImageService + LuminanceService
                    ├── PaletteManagementInterface() → 创建 PaletteService
                    ├── ColorGenerationInterface()
                    ├── PresetColorInterface()
                    ├── ColorPreviewInterface()
                    └── SettingsInterface()
```

### 1.3 服务依赖分析

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  ColorService   │     │ PaletteService  │     │  ImageService   │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ 依赖:           │     │ 依赖:           │     │ 依赖:           │
│ - color.py      │     │ - color.py      │     │ - PIL           │
│                 │     │ - grouping.py   │     │ - image_memory  │
│ 轻量初始化      │     │ - json, uuid    │     │ - ColorSpace    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │                       │
        └───────────────────────┴───────────────────────┘
                                │
                    服务间无直接依赖，各自独立
```

**结论**: 服务架构良好，无循环依赖，适合延迟加载改造。

---

## 2. 延迟加载策略

### 2.1 分阶段实施

| 阶段 | 内容 | 风险 | 收益 |
|:---:|:---|:---:|:---:|
| **阶段1** | 服务内部延迟初始化 | 低 | 中 |
| **阶段2** | ServiceFactory 服务工厂 | 中 | 高 |
| **阶段3** | UI 加载状态显示 | 低 | 高 |

### 2.2 阶段1：服务内部延迟初始化

**原则**: 不改变服务获取方式，延迟服务内部的重资源初始化。

**改造范围**:

| 服务 | 当前初始化内容 | 延迟初始化内容 |
|:---|:---|:---|
| ColorService | `_extractor = None` | 无重资源，无需改造 |
| PaletteService | `_importer = None`, `_exporter = None` | 无重资源，无需改造 |
| ImageService | `_loader = None`, `_memory_manager` | `_memory_manager` 可延迟获取 |
| LuminanceService | `_calculator = None` | 无重资源，无需改造 |

**ImageService 改造示例**:

```python
class ImageService(QObject):
    def __init__(self, parent=None):
        super().__init__(parent)
        self._loader: Optional[ProgressiveImageLoader] = None
        self._current_path: Optional[str] = None
        self._colorspace_info: Optional[ColorSpaceInfo] = None
        self._memory_manager = None  # 延迟初始化
    
    def _get_memory_manager(self):
        """延迟获取内存管理器"""
        if self._memory_manager is None:
            from .image_memory_manager import get_memory_manager
            self._memory_manager = get_memory_manager()
        return self._memory_manager
```

### 2.3 阶段2：ServiceFactory 服务工厂

**目标**: 统一服务获取入口，实现服务单例化和延迟创建。

**新建文件**: `core/service_factory.py`

```python
"""服务工厂模块

提供统一的服务获取入口，实现服务单例化和延迟创建。
"""

from typing import Optional


class ServiceFactory:
    """服务工厂，管理服务的创建和生命周期
    
    特性：
    - 延迟创建：服务在首次使用时才创建
    - 单例模式：同一服务只创建一个实例
    - 线程安全：使用锁保护实例创建
    """
    
    _instances = {}
    _lock = None
    
    @classmethod
    def _get_lock(cls):
        """延迟获取锁（避免启动时导入 threading）"""
        if cls._lock is None:
            import threading
            cls._lock = threading.Lock()
        return cls._lock
    
    @classmethod
    def get_color_service(cls, parent=None):
        """获取颜色服务实例
        
        Args:
            parent: 父对象（首次创建时使用）
            
        Returns:
            ColorService: 颜色服务实例
        """
        if 'color' not in cls._instances:
            with cls._get_lock():
                if 'color' not in cls._instances:
                    from .color_service import ColorService
                    cls._instances['color'] = ColorService(parent)
        return cls._instances['color']
    
    @classmethod
    def get_palette_service(cls, parent=None):
        """获取配色服务实例"""
        if 'palette' not in cls._instances:
            with cls._get_lock():
                if 'palette' not in cls._instances:
                    from .palette_service import PaletteService
                    cls._instances['palette'] = PaletteService(parent)
        return cls._instances['palette']
    
    @classmethod
    def get_image_service(cls, parent=None):
        """获取图片服务实例"""
        if 'image' not in cls._instances:
            with cls._get_lock():
                if 'image' not in cls._instances:
                    from .image_service import ImageService
                    cls._instances['image'] = ImageService(parent)
        return cls._instances['image']
    
    @classmethod
    def get_luminance_service(cls, parent=None):
        """获取明度服务实例"""
        if 'luminance' not in cls._instances:
            with cls._get_lock():
                if 'luminance' not in cls._instances:
                    from .luminance_service import LuminanceService
                    cls._instances['luminance'] = LuminanceService(parent)
        return cls._instances['luminance']
    
    @classmethod
    def clear_all(cls):
        """清除所有服务实例（用于测试或重置）"""
        with cls._get_lock():
            cls._instances.clear()
```

**UI 组件改造示例**:

```python
# 修改前
from core import ColorService

class ColorExtractInterface(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self._color_service = ColorService(self)

# 修改后
from core import ServiceFactory

class ColorExtractInterface(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self._color_service = None  # 延迟获取
    
    def _get_color_service(self):
        """延迟获取颜色服务"""
        if self._color_service is None:
            self._color_service = ServiceFactory.get_color_service(self)
        return self._color_service
```

### 2.4 阶段3：UI 加载状态显示

**目标**: 在服务首次加载时显示加载状态，提升用户体验。

**实现方案**:

1. **ServiceFactory 添加加载信号**:

```python
class ServiceFactory:
    service_loading = Signal(str)    # 服务名称
    service_loaded = Signal(str)     # 服务名称
    
    @classmethod
    def get_color_service(cls, parent=None):
        cls.service_loading.emit('color')
        # ... 创建服务 ...
        cls.service_loaded.emit('color')
        return cls._instances['color']
```

2. **MainWindow 监听加载状态**:

```python
class MainWindow(FluentWindow):
    def __init__(self):
        super().__init__()
        # ...
        ServiceFactory.service_loading.connect(self._on_service_loading)
        ServiceFactory.service_loaded.connect(self._on_service_loaded)
    
    def _on_service_loading(self, service_name: str):
        """服务加载中，显示状态"""
        # 可在状态栏显示 "正在加载..."
        pass
    
    def _on_service_loaded(self, service_name: str):
        """服务加载完成"""
        pass
```

---

## 3. 实施计划

### 3.1 任务分解

| 任务ID | 任务内容 | 优先级 | 预估工作量 |
|:---:|:---|:---:|:---:|
| 6.1.1 | ImageService 内部延迟初始化 | 高 | 0.5h |
| 6.1.2 | 创建 ServiceFactory 模块 | 高 | 1h |
| 6.1.3 | 更新 core/__init__.py 导出 | 高 | 0.25h |
| 6.1.4 | 改造 ColorExtractInterface | 中 | 0.5h |
| 6.1.5 | 改造 PaletteManagementInterface | 中 | 0.5h |
| 6.1.6 | 改造 ImageCanvas / LuminanceCanvas | 中 | 0.5h |
| 6.1.7 | 添加 UI 加载状态显示 | 低 | 1h |
| 6.1.8 | 更新开发规范文档 | 中 | 0.25h |
| 6.1.9 | 功能测试验证 | 高 | 0.5h |

### 3.2 执行顺序

```
阶段1（低风险）
    └── 6.1.1 ImageService 内部延迟初始化

阶段2（核心改造）
    ├── 6.1.2 创建 ServiceFactory 模块
    ├── 6.1.3 更新 core/__init__.py 导出
    ├── 6.1.4 改造 ColorExtractInterface
    ├── 6.1.5 改造 PaletteManagementInterface
    └── 6.1.6 改造 ImageCanvas / LuminanceCanvas

阶段3（体验优化）
    ├── 6.1.7 添加 UI 加载状态显示
    └── 6.1.8 更新开发规范文档

验收
    └── 6.1.9 功能测试验证
```

---

## 4. 验收标准

### 4.1 功能验收

- [ ] 所有界面功能正常
- [ ] 服务信号连接正确
- [ ] 无内存泄漏
- [ ] 无循环依赖

### 4.2 性能验收

| 指标 | 改造前 | 改造后目标 | 测量方法 |
|:---|:---:|:---:|:---|
| 启动时间 | - | 减少 50%+ | 计时测量 |
| 首次界面显示 | - | < 1s | 计时测量 |
| 内存占用 | - | 无明显增加 | 任务管理器 |

### 4.3 代码质量

- [ ] 遵循开发规范命名约定
- [ ] 添加必要的文档字符串
- [ ] 清理未使用的导入
- [ ] 通过类型检查

---

## 5. 风险与应对

| 风险 | 影响 | 应对措施 |
|:---|:---:|:---|
| 服务信号连接丢失 | 高 | 保留服务引用，不重复创建 |
| 线程安全问题 | 中 | 使用双重检查锁定 |
| 父对象管理混乱 | 中 | ServiceFactory 不持有父对象引用 |
| 测试覆盖不足 | 低 | 手动测试所有界面功能 |

---

## 6. 后续优化

完成本计划后，可考虑以下进一步优化：

1. **服务预热**: 在应用空闲时预加载常用服务
2. **服务依赖图**: 自动分析服务依赖，优化加载顺序
3. **性能监控**: 添加服务加载时间统计
4. **缓存策略**: 对服务计算结果进行缓存

---

## 附录：相关文件清单

| 文件 | 操作 |
|:---|:---:|
| `core/service_factory.py` | 新建 |
| `core/__init__.py` | 修改 |
| `core/image_service.py` | 修改 |
| `ui/color_extract.py` | 修改 |
| `ui/palette_management.py` | 修改 |
| `ui/canvases.py` | 修改 |
| `ui/main_window.py` | 修改（阶段3） |
| `文档/开发规范.md` | 修改 |
