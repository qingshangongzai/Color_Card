# 配色预览功能重构计划

## 重构目标

将现有的"JSON配置+代码渲染"模式统一改为"纯SVG模板"模式，实现：
1. 所有场景统一使用SVG格式
2. 内置SVG只读不可删改
3. 用户可导入自定义SVG到任意场景类型
4. 同一场景类型支持多个SVG同时预览
5. 支持批量导出当前配色下的所有SVG

---

## SVG颜色映射机制

### 映射原理

现有的 `SVGColorMapper` 使用**智能映射**策略：

```
SVG导入 → 元素分类 → 颜色收集 → 面积排序 → 映射配色
```

### 元素分类依据

| 优先级 | 依据 | 示例 |
|:------:|------|------|
| 1 | class 属性关键词 | `class="background"` → 背景 |
| 2 | id 属性关键词 | `id="main-title"` → 文字 |
| 3 | 标签类型 + 面积 | 最大矩形 → 背景 |

### 支持的关键词

| 元素类型 | class/id 关键词 | 颜色映射 |
|---------|----------------|---------|
| 背景 | `background`, `bg`, `back` | 配色[0] |
| 主元素 | `primary`, `main` | 配色[1] |
| 次要元素 | `secondary`, `sub` | 配色[2] |
| 强调元素 | `accent`, `highlight` | 配色[3] |
| 文字 | `text`, `title`, `label` | 配色[4] |
| 描边 | `stroke`, `border`, `line` | 配色[4] |

### 映射策略

**有背景元素时**：
```
背景色（面积最大）→ 配色[0]
其他颜色 → 配色[1..n]（循环）
```

**无背景元素（透明背景）时**：
```
所有颜色 → 配色[1..n]（循环）
```

---

## 当前架构分析

### 现有代码结构

```
core/
├── config.py                    # SceneConfigManager（需重构）
└── svg_color_mapper.py          # SVGColorMapper（保留）

preview_scenes/                  # 过渡目录（重构完成后删除）
├── scenes.json                  # 场景配置（需重构）
├── builtin/                     # 原型SVG（临时）
└── user_scenes/                 # 用户场景（需重构）

scenes_data/                     # 新目录（重构目标）
├── ui/default.svg               # 已创建
└── web/default.svg              # 已创建

ui/preview_widgets.py
├── BasePreviewScene             # 场景基类（保留）
├── PreviewSceneFactory          # 场景工厂（需重构）
├── SceneRenderer                # 场景渲染器（删除）
├── ConfigurablePreviewScene     # 配置化场景（删除）
├── IllustrationPreview          # 插画预览（删除或保留为SVG）
├── TypographyPreview            # 排版预览（删除或保留为SVG）
├── PreviewSceneSelector         # 场景选择器（需重构）
├── MixedPreviewPanel            # Mixed面板（需重构）
├── PreviewToolbar               # 预览工具栏（需重构）
└── SVGPreviewWidget             # SVG预览组件（核心，保留并增强）
```

### 现有场景类型

| 场景ID | 当前实现方式 | 重构后 |
|--------|-------------|--------|
| custom | SVG加载 | SVG（不变） |
| mixed | 组合组件 | SVG组合 |
| ui | JSON+代码渲染 | SVG模板 |
| web | JSON+代码渲染 | SVG模板 |
| illustration | JSON+代码渲染 | SVG模板 |
| typography | JSON+代码渲染 | SVG模板 |
| brand | JSON+代码渲染 | SVG模板 |
| poster | JSON+代码渲染 | SVG模板 |
| pattern | JSON+代码渲染 | SVG模板 |
| magazine | JSON+代码渲染 | SVG模板 |

---

## 重构计划

### 阶段一：原型验证（必须先完成）

**目标**：验证SVG统一方案的可行性

**步骤**：

#### 1.1 确认映射机制

- 验证现有 `SVGColorMapper` 的智能映射效果
- 确认语义化命名规范的有效性
- 测试不同SVG结构的映射结果

#### 1.2 创建原型SVG模板

使用语义化命名创建模板：

```svg
<!-- ui_default.svg 示例 -->
<svg viewBox="0 0 400 300">
  <!-- 背景 -->
  <rect id="background" class="background" width="400" height="300" fill="#f5f5f5"/>
  
  <!-- 手机框架 -->
  <rect id="phone-frame" class="primary" x="120" y="30" width="160" height="240" rx="20" fill="#1a1a1a"/>
  
  <!-- 状态栏 -->
  <rect id="status-bar" class="secondary" x="130" y="40" width="140" height="25" rx="8" fill="#333333"/>
  
  <!-- 内容卡片 -->
  <rect id="content-card" class="accent" x="130" y="75" width="140" height="60" rx="10" fill="#ff6b6b"/>
  
  <!-- 底部导航 -->
  <rect id="bottom-nav" class="secondary" x="130" y="235" width="140" height="25" rx="8" fill="#333333"/>
</svg>
```

- 创建 `ui_default.svg` 原型模板
- 创建 `web_default.svg` 原型模板
- 测试颜色替换效果

#### 1.3 修改场景加载逻辑

- 创建新的 `SceneTypeManager` 类
- 支持从目录加载多个SVG
- 区分内置/用户模板

#### 1.4 验证功能

- 加载内置SVG
- 导入用户SVG
- 颜色替换正确性
- 导出SVG功能

**验证通过标准**：
- [ ] 内置SVG正确加载和显示
- [ ] 用户SVG可以导入
- [ ] 颜色替换效果正确
- [ ] SVG可以导出
- [ ] 性能可接受（加载时间<500ms）

---

### 阶段二：数据结构重构

**前提**：阶段一验证通过

**过渡策略**：
- `preview_scenes/` 作为过渡目录保留
- 新功能在 `scenes_data/` 中开发
- 重构完成后删除 `preview_scenes/`

#### 2.1 新的目录结构

**参考 `color_data/` 的组织方式**：

```
scenes_data/                         # 场景数据目录（新）
├── scene_types.json                 # 场景类型定义
├── ui/                              # 手机UI场景
│   ├── default.svg                  # 内置模板
│   └── index.json                   # 用户模板索引
├── web/                             # 网页场景
│   ├── default.svg
│   └── index.json
├── illustration/                    # 插画场景
│   ├── default.svg
│   └── index.json
├── typography/                      # 排版场景
│   ├── default.svg
│   └── index.json
├── brand/                           # 品牌场景
│   ├── default.svg
│   └── index.json
├── poster/                          # 海报场景
│   ├── default.svg
│   └── index.json
├── pattern/                         # 图案场景
│   ├── default.svg
│   └── index.json
├── magazine/                        # 杂志场景
│   ├── default.svg
│   └── index.json
└── custom/                          # 自定义场景（无内置模板）
    └── index.json
```

**与 `color_data/` 结构对比**：
```
color_data/                          # 配色数据
├── catppuccin.json
├── dracula.json
└── ...

scenes_data/                         # 场景数据（新）
├── scene_types.json
├── ui/
│   ├── default.svg
│   └── index.json
└── ...
```

**删除**：
- `preview_scenes/` 目录（旧）

#### 2.2 新的配置格式

**scene_types.json**：
```json
{
  "version": "3.0",
  "scene_types": [
    {
      "id": "ui",
      "name": "手机UI",
      "icon": "phone",
      "description": "手机应用界面预览",
      "builtin": true
    },
    {
      "id": "web",
      "name": "网页",
      "icon": "web",
      "description": "网页布局预览",
      "builtin": true
    },
    {
      "id": "custom",
      "name": "自定义",
      "icon": "svg",
      "description": "自定义SVG预览",
      "builtin": false
    }
  ]
}
```

#### 2.3 用户模板索引

**每个场景目录下的 `index.json`**：

`scenes_data/ui/index.json`：
```json
{
  "user_templates": [
    {"file": "my_ui_1.svg", "name": "我的UI模板1", "added_at": "2026-02-16"}
  ]
}
```

`scenes_data/custom/index.json`：
```json
{
  "user_templates": [
    {"file": "custom_1.svg", "name": "自定义模板1", "added_at": "2026-02-16"}
  ]
}
```

---

### 阶段三：数据结构与代码重构（合并）

**说明**：阶段三和阶段四合为一个阶段，确保数据结构迁移后立即应用新的SVG渲染逻辑。

#### 3.1 数据结构重构

1. **创建 `scene_types.json`** - 场景类型定义
2. **创建各场景目录** - `ui/`, `web/`, `illustration/` 等
3. **创建 `index.json`** - 每个场景目录下的用户模板索引
4. **迁移内置SVG** - 从原型位置移动到正式位置

#### 3.2 新增类

| 类名 | 职责 | 文件 |
|------|------|------|
| `SceneTypeManager` | 管理场景类型和模板 | core/config.py |
| `TemplateGallery` | 多SVG网格展示 | ui/preview_widgets.py |
| `TemplateCard` | 单个SVG卡片 | ui/preview_widgets.py |

#### 3.3 修改类

| 类名 | 修改内容 |
|------|---------|
| `SVGPreviewWidget` | 增强功能，支持模板模式 |
| `PreviewSceneSelector` | 改为场景类型选择器 |
| `PreviewToolbar` | 增加导入/导出按钮 |
| `MixedPreviewPanel` | 改为SVG组合展示 |
| `ColorPreviewInterface` | 改为从 `scenes_data/` 加载SVG |

#### 3.4 删除类

| 类名 | 原因 |
|------|------|
| `SceneRenderer` | 不再需要代码渲染 |
| `ConfigurablePreviewScene` | 统一用SVG |
| `IllustrationPreview` | 转为SVG模板 |
| `TypographyPreview` | 转为SVG模板 |

#### 3.5 关键修改点

**场景加载逻辑修改**：
```python
# 旧逻辑（从JSON配置渲染）
scene = ConfigurablePreviewScene(config)
renderer = SceneRenderer()
renderer.render(scene)

# 新逻辑（从SVG加载）
scene_type_manager = SceneTypeManager()
svg_path = scene_type_manager.get_builtin_template("ui")
svg_widget = SVGPreviewWidget()
svg_widget.load_svg(svg_path)
```

---

### 阶段四：功能完善

#### 4.1 导入功能
- 支持拖拽导入SVG
- 支持文件选择器导入
- 自动归类到当前场景类型
- 导入后显示映射预览

#### 4.2 导出功能
- 导出单个SVG（已应用配色）
- 批量导出所有SVG
- 导出为PNG图片（可选）

#### 4.3 管理功能
- 重命名用户模板
- 删除用户模板
- 模板排序

---

### 阶段五：清理与优化

#### 5.1 代码清理
- 删除废弃类
- 清理无用导入
- 更新文档

#### 5.2 性能优化
- SVG缓存机制
- 延迟加载
- 渲染优化

#### 5.3 测试验证
- 功能测试
- 边界测试
- 性能测试

---

## 风险与对策

| 风险 | 影响 | 对策 |
|------|------|------|
| SVG渲染性能差 | 用户体验 | 缓存+延迟加载 |
| 颜色映射不准确 | 显示错误 | 语义化命名规范 |
| 用户导入恶意SVG | 安全问题 | SVG内容校验 |
| 旧配置不兼容 | 数据丢失 | 迁移脚本 |

---

## 时间估算

| 阶段 | 预计时间 | 备注 |
|------|---------|------|
| 阶段一：原型验证 | 1-2天 | ✅ 已完成 |
| 阶段二：创建内置SVG模板 | 1-2天 | 下一步 |
| 阶段三：数据结构与代码重构 | 2-3天 | 核心工作（合并） |
| 阶段四：功能完善 | 1-2天 | - |
| 阶段五：清理与优化 | 0.5天 | - |

**总计**：5-8天

---

## 下一步行动

### 阶段一：原型验证 ✅ 已完成

**验证结果**：
- [x] 确认 `SVGColorMapper` 智能映射效果
- [x] 创建 `ui_default.svg` 原型模板（使用语义化命名）
- [x] 创建 `web_default.svg` 原型模板
- [x] 验证颜色替换效果
- [x] 确认两种映射方式都可用

**测试文件**：
- `test_svg_mapping.py` - 保留至重构完全结束后删除
- 用于后续阶段参考和验证

**产出文件**：
```
preview_scenes/builtin/          # 原型SVG（过渡目录）
├── ui_default.svg               # 手机UI模板
└── web_default.svg              # 网页布局模板

scenes_data/                     # 新目录
├── ui/default.svg               # 已迁移
└── web/default.svg              # 已迁移
```

### 阶段二：创建所有内置SVG模板（下一步）

**目标**：创建剩余6个内置场景的SVG模板

**待创建模板**：
| 模板 | 描述 | 状态 |
|------|------|:----:|
| `ui/default.svg` | 手机UI界面 | ✅ 已创建 |
| `web/default.svg` | 网页布局 | ✅ 已创建 |
| `illustration/default.svg` | 插画预览 | ⬜ 待创建 |
| `typography/default.svg` | 文字排版 | ⬜ 待创建 |
| `brand/default.svg` | 品牌设计 | ⬜ 待创建 |
| `poster/default.svg` | 海报设计 | ⬜ 待创建 |
| `pattern/default.svg` | 图案纹理 | ⬜ 待创建 |
| `magazine/default.svg` | 杂志排版 | ⬜ 待创建 |

**步骤**：
1. 创建 `illustration/default.svg`
2. 创建 `typography/default.svg`
3. 创建 `brand/default.svg`
4. 创建 `poster/default.svg`
5. 创建 `pattern/default.svg`
6. 创建 `magazine/default.svg`

### 阶段三：数据结构与代码重构（合并）

**目标**：数据结构迁移 + 代码重构同时进行

**步骤**：
1. **数据结构准备**
   - 创建 `scene_types.json` 配置文件
   - 创建各场景目录下的 `index.json`
   - 迁移内置SVG到正式位置

2. **代码重构**
   - 实现 `SceneTypeManager` 类
   - 修改 `ColorPreviewInterface` 加载逻辑
   - 修改 `PreviewSceneSelector` 场景选择
   - 删除废弃类 (`SceneRenderer`, `ConfigurablePreviewScene` 等)

3. **联调测试**
   - 验证新数据结构能正确加载
   - 验证SVG能正确渲染
   - 验证颜色映射正确

4. **清理**
   - 删除 `preview_scenes/` 目录
   - 删除废弃代码
