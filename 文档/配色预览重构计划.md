# 配色预览功能重构计划

## 重构目标

将现有的"JSON配置+代码渲染"模式统一改为"纯SVG模板"模式，实现：
1. 所有场景统一使用SVG格式
2. 内置SVG只读不可删改
3. 用户可导入自定义SVG到任意场景类型
4. 同一场景类型支持多个SVG同时预览
5. 支持批量导出当前配色下的所有SVG

---

## 当前架构分析

### 现有代码结构

```
core/
├── config.py                    # SceneConfigManager（需重构）
└── svg_color_mapper.py          # SVGColorMapper（保留）

preview_scenes/
├── scenes.json                  # 场景配置（需重构）
└── user_scenes/                 # 用户场景（需重构）

ui/preview_widgets.py
├── BasePreviewScene             # 场景基类（保留）
├── PreviewSceneFactory          # 场景工厂（需重构）
├── SceneRenderer                # 场景渲染器（删除）
├── ConfigurablePreviewScene     # 配置化场景（删除）
├── IllustrationPreview          # 插画预览（删除或保留为SVG）
├── TypographyPreview            # 排版预览（删除或保留为SVG）
├── PreviewSceneSelector         # 场景选择器（需重构）
├── MixedPreviewPanel            # Mixed面板（需重构）
├── PreviewToolbar               # 预览工具栏（需重构）
└── SVGPreviewWidget             # SVG预览组件（核心，保留并增强）
```

### 现有场景类型

| 场景ID | 当前实现方式 | 重构后 |
|--------|-------------|--------|
| custom | SVG加载 | SVG（不变） |
| mixed | 组合组件 | SVG组合 |
| ui | JSON+代码渲染 | SVG模板 |
| web | JSON+代码渲染 | SVG模板 |
| illustration | JSON+代码渲染 | SVG模板 |
| typography | JSON+代码渲染 | SVG模板 |
| brand | JSON+代码渲染 | SVG模板 |
| poster | JSON+代码渲染 | SVG模板 |
| pattern | JSON+代码渲染 | SVG模板 |
| magazine | JSON+代码渲染 | SVG模板 |

---

## 重构计划

### 阶段一：原型验证（必须先完成）

**目标**：验证SVG统一方案的可行性

**步骤**：

#### 1.1 创建SVG模板规范
- 定义SVG颜色占位符命名规范
- 创建SVG模板编写指南

#### 1.2 创建原型SVG模板
- 将 `ui` 场景转换为SVG模板
- 将 `web` 场景转换为SVG模板
- 测试颜色替换效果

#### 1.3 修改场景加载逻辑
- 创建新的 `SceneTypeManager` 类
- 支持从目录加载多个SVG
- 区分内置/用户模板

#### 1.4 验证功能
- 加载内置SVG
- 导入用户SVG
- 颜色替换正确性
- 导出SVG功能

**验证通过标准**：
- [ ] 内置SVG正确加载和显示
- [ ] 用户SVG可以导入
- [ ] 颜色替换效果正确
- [ ] SVG可以导出
- [ ] 性能可接受（加载时间<500ms）

---

### 阶段二：数据结构重构

**前提**：阶段一验证通过

#### 2.1 新的目录结构

```
preview_scenes/
├── scene_types.json             # 场景类型定义（新）
├── builtin/                     # 内置SVG模板（新）
│   ├── ui_default.svg
│   ├── web_default.svg
│   ├── illustration_default.svg
│   ├── typography_default.svg
│   ├── brand_default.svg
│   ├── poster_default.svg
│   ├── pattern_default.svg
│   └── magazine_default.svg
└── user_templates/              # 用户导入的模板（新）
    ├── ui/
    ├── web/
    ├── illustration/
    ├── typography/
    ├── brand/
    ├── poster/
    ├── pattern/
    ├── magazine/
    └── custom/
```

#### 2.2 新的配置格式

**scene_types.json**：
```json
{
  "version": "3.0",
  "scene_types": [
    {
      "id": "ui",
      "name": "手机UI",
      "icon": "phone",
      "description": "手机应用界面预览",
      "builtin_count": 1
    },
    {
      "id": "web",
      "name": "网页",
      "icon": "web",
      "description": "网页布局预览",
      "builtin_count": 1
    },
    {
      "id": "custom",
      "name": "自定义",
      "icon": "svg",
      "description": "自定义SVG预览",
      "builtin_count": 0
    }
  ]
}
```

#### 2.3 用户模板索引

**user_templates/index.json**：
```json
{
  "ui": [
    {"file": "my_ui_1.svg", "name": "我的UI模板1", "added_at": "2026-02-16"}
  ],
  "web": []
}
```

---

### 阶段三：代码重构

#### 3.1 新增类

| 类名 | 职责 | 文件 |
|------|------|------|
| `SceneTypeManager` | 管理场景类型和模板 | core/config.py |
| `TemplateGallery` | 多SVG网格展示 | ui/preview_widgets.py |
| `TemplateCard` | 单个SVG卡片 | ui/preview_widgets.py |

#### 3.2 修改类

| 类名 | 修改内容 |
|------|---------|
| `SVGPreviewWidget` | 增强功能，支持模板模式 |
| `PreviewSceneSelector` | 改为场景类型选择器 |
| `PreviewToolbar` | 增加导入/导出按钮 |
| `MixedPreviewPanel` | 改为SVG组合展示 |

#### 3.3 删除类

| 类名 | 原因 |
|------|------|
| `SceneRenderer` | 不再需要代码渲染 |
| `ConfigurablePreviewScene` | 统一用SVG |
| `IllustrationPreview` | 转为SVG模板 |
| `TypographyPreview` | 转为SVG模板 |

---

### 阶段四：SVG模板创建

#### 4.1 内置SVG模板清单

| 模板文件 | 描述 | 颜色占位符数量 |
|---------|------|--------------|
| ui_default.svg | 手机UI界面 | 5 |
| web_default.svg | 网页布局 | 5 |
| illustration_default.svg | 植物插画 | 4 |
| typography_default.svg | 文字排版 | 4 |
| brand_default.svg | 品牌设计 | 5 |
| poster_default.svg | 海报设计 | 5 |
| pattern_default.svg | 图案纹理 | 5 |
| magazine_default.svg | 杂志排版 | 5 |

#### 4.2 SVG颜色占位符规范

```svg
<!-- 方式1：CSS变量 -->
<rect fill="var(--color-0)"/>
<circle fill="var(--color-1)"/>

<!-- 方式2：CSS类名 -->
<rect class="color-0"/>
<circle class="color-1"/>

<!-- 方式3：data属性（推荐） -->
<rect data-color-idx="0"/>
<circle data-color-idx="1"/>
```

---

### 阶段五：功能完善

#### 5.1 导入功能
- 支持拖拽导入SVG
- 支持文件选择器导入
- 自动归类到当前场景类型

#### 5.2 导出功能
- 导出单个SVG
- 批量导出所有SVG
- 导出为PNG图片（可选）

#### 5.3 管理功能
- 重命名用户模板
- 删除用户模板
- 模板排序

---

### 阶段六：清理与优化

#### 6.1 代码清理
- 删除废弃类
- 清理无用导入
- 更新文档

#### 6.2 性能优化
- SVG缓存机制
- 延迟加载
- 渲染优化

#### 6.3 测试验证
- 功能测试
- 边界测试
- 性能测试

---

## 风险与对策

| 风险 | 影响 | 对策 |
|------|------|------|
| SVG渲染性能差 | 用户体验 | 缓存+延迟加载 |
| 颜色映射不准确 | 显示错误 | 完善占位符规范 |
| 用户导入恶意SVG | 安全问题 | SVG内容校验 |
| 旧配置不兼容 | 数据丢失 | 迁移脚本 |

---

## 时间估算

| 阶段 | 预计时间 | 备注 |
|------|---------|------|
| 阶段一：原型验证 | 1-2天 | 必须先完成 |
| 阶段二：数据结构重构 | 0.5天 | 验证通过后 |
| 阶段三：代码重构 | 2-3天 | 核心工作 |
| 阶段四：SVG模板创建 | 1-2天 | 可并行 |
| 阶段五：功能完善 | 1-2天 | - |
| 阶段六：清理与优化 | 0.5天 | - |

**总计**：6-10天

---

## 下一步行动

**立即开始阶段一：原型验证**

1. 创建 `ui_default.svg` 原型模板
2. 创建 `web_default.svg` 原型模板
3. 修改加载逻辑验证可行性
4. 确认颜色替换效果

原型验证通过后，再继续后续阶段。
