# Color Card 核心原则

## 1. 技术栈

| 项目 | 说明 |
|:---:|:---|
| Python | 3.11+ |
| GUI 框架 | PySide6 + PySide6-Fluent-Widgets |
| 注释语言 | 中文 |

---

## 2. 目录结构

```
color_card/
├── main.py                 # 程序入口
├── core/                   # 核心功能模块
│   ├── color.py           # 颜色处理
│   ├── config.py          # 配置管理
│   └── ...
├── ui/                     # UI 模块（扁平化）
│   ├── main_window.py     # 主窗口
│   ├── canvases.py        # 画布组件
│   ├── cards.py           # 卡片组件
│   ├── theme_colors.py    # 主题颜色管理
│   └── ...
├── dialogs/               # 对话框模块
├── utils/                 # 工具函数
└── color_data/            # 颜色数据（JSON）
```

**核心理念：公共模块统一管理，业务模块按需调用**

---

## 3. 命名规范

| 类型 | 规范 | 示例 |
|:---:|:---:|:---|
| 类名 | 驼峰命名法 | `ColorPicker`, `ImageCanvas` |
| 函数/方法 | 小写+下划线 | `extract_color()` |
| 变量 | 小写+下划线 | `picker_positions` |
| 常量 | 大写+下划线 | `PICKER_RADIUS = 12` |
| 私有属性 | 单下划线前缀 | `_dragging` |
| 信号 | 小写+下划线 | `color_picked = Signal(int, tuple)` |

---

## 4. 导入顺序

```python
# 标准库导入
import sys
from pathlib import Path

# 第三方库导入
from PySide6.QtWidgets import QWidget
from qfluentwidgets import FluentWindow, setTheme, Theme

# 项目模块导入
from core import get_color_info
from ui.theme_colors import get_text_color
```

**导入清理原则：**
- 按模块类型分组导入，添加清晰的分组注释
- 定期清理未使用的导入，合并同一模块的多次导入
- 优先使用绝对导入

---

## 5. 代码风格

| 规则 | 说明 |
|:---:|:---|
| 代码风格 | PEP 8 |
| 缩进 | 4 空格 |
| 行长 | ≤ 100 字符 |

---

## 6. 关键约束

### 6.1 颜色管理

```python
# 禁止硬编码颜色
painter.setPen(QColor(255, 255, 255))  # ❌ 错误

# 必须使用主题颜色模块
from ui.theme_colors import get_text_color
painter.setPen(get_text_color())  # ✓ 正确
```

### 6.2 信号同步防循环

```python
# 双向同步时使用 emit_sync 参数
def set_image_data(self, pixmap, image, emit_sync=True):
    self._pixmap = pixmap
    if emit_sync:  # 只在独立操作时发射信号
        self.image_loaded.emit()
```

### 6.3 主题切换

```python
from qfluentwidgets import qconfig, isDarkTheme

# 监听主题变化
qconfig.themeChangedFinished.connect(self._update_styles)

# 更新样式
def _update_styles(self):
    if isDarkTheme():
        # 深色主题样式
        pass
```

### 6.4 异常处理

```python
# 禁止裸 except
except Exception:  # ❌ 错误
    pass

# 必须指定具体类型
except (OSError, ValueError) as e:  # ✓ 正确
    print(f"错误: {e}")
```

### 6.5 QSplitter 样式

```python
# 所有 QSplitter 必须隐藏分隔条
splitter = QSplitter(Qt.Orientation.Vertical)
splitter.setHandleWidth(0)  # 必须设置
```

### 6.6 代码清理同步

修改代码时同步清理相关重复代码，避免遗留冗余逻辑。

- 删除未使用的变量、函数、导入和注释
- 合并重复的逻辑和相似的功能
- 检查并清除相关的重复冗余代码
- 保持代码整洁，提高代码复用性

### 6.7 基类设计

- 单一职责：一个基类只负责一类功能
- 接口清晰：抽象方法定义明确
- 可扩展：便于添加新子类

### 6.8 多线程使用

耗时操作（复杂计算等场景）应使用多线程，避免阻塞UI主线程。

---

## 7. 文档规范

### 7.1 编写原则

禁止使用浮夸、空洞的词汇，保持务实、准确的表述风格。

如：最佳实践这类词应禁止使用，而应使用更具体的描述。

### 7.2 文档字符串

公共类和方法必须添加文档字符串，使用中文。

**示例：**

```python
class ImageCanvas(QWidget):
    """图片显示画布，支持取色点拖动"""
    pass

def get_color_info(self, r, g, b):
    """获取颜色信息
    
    Args:
        r: 红色通道值 (0-255)
        g: 绿色通道值 (0-255)
        b: 蓝色通道值 (0-255)
    
    Returns:
        dict: 包含RGB、HSB、LAB、HEX颜色信息
    """
    pass
```

---

## 8. 常用模块导入

```python
# 主题颜色
from ui.theme_colors import (
    get_text_color,
    get_card_background_color,
    get_border_color
)

# 配置管理
from core import get_config_manager, get_scene_config_manager

# Fluent Widgets
from qfluentwidgets import (
    FluentWindow, setTheme, Theme, FluentIcon,
    RoundMenu, Action, MessageBox, qconfig, isDarkTheme
)
```

---

## 9. Windows 原生标题栏深色模式

对于继承自 `QDialog` 的对话框，使用 Windows DWM API 设置原生标题栏主题：

```python
from qfluentwidgets import isDarkTheme, qconfig
from utils import set_window_title_bar_theme

class MyDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        qconfig.themeChangedFinished.connect(self._update_title_bar_theme)
    
    def showEvent(self, event):
        """窗口显示前设置标题栏主题，避免闪烁"""
        self._update_title_bar_theme()
        super().showEvent(event)
    
    def _update_title_bar_theme(self):
        """更新标题栏主题"""
        set_window_title_bar_theme(self, isDarkTheme())
```
