# 类型注解优化计划

## 概述

基于对代码库的全面检查，发现存在多处类型注解不规范的问题。本计划详细列出所有问题并提供具体的优化方案。

---

## 问题分类与优化方案

### 问题一：使用小写内置类型而非大写 Typing 类型

#### 1.1 使用 `list` 而非 `List`（20处）

**示例问题 - `core/color.py` 第25行：**

```python
# 修改前
def _generate_saturation_steps(base_saturation: float, count: int) -> list:

# 修改后
from typing import List
def _generate_saturation_steps(base_saturation: float, count: int) -> List[float]:
```

**示例问题 - `ui/color_wheel.py` 第399行：**

```python
# 修改前
def set_scheme_colors(self, colors: list):

# 修改后
from typing import List
def set_scheme_colors(self, colors: List[str]):
```

**示例问题 - `ui/canvases.py` 第714行：**

```python
# 修改前
self._pickers: list = []

# 修改后
from typing import List
self._pickers: List[ColorPicker] = []
```

**完整列表：**

| 文件路径 | 行号 | 当前代码 | 优化后代码 |
|---------|------|---------|-----------|
| core/color.py | 25 | `-> list:` | `-> List[float]:` |
| core/color.py | 46 | `-> list:` | `-> List[float]:` |
| ui/color_wheel.py | 399 | `colors: list` | `colors: List[str]` |
| ui/canvases.py | 714 | `_pickers: list` | `_pickers: List[ColorPicker]` |
| ui/main_window.py | 445 | `colors: list` | `colors: List[str]` |
| core/config.py | 344 | `favorites: list` | `favorites: List[dict]` |
| ui/color_preview.py | 791 | `colors: list` | `colors: List[str]` |
| ui/preset_color.py | 346 | `colors: list` | `colors: List[str]` |
| ui/preset_color.py | 555 | `data: list` | `data: List[PaletteCard]` |
| ui/preset_color.py | 576 | `palettes: list` | `palettes: List[dict]` |
| ui/palette_management.py | 41 | `favorites: list` | `favorites: List[dict]` |
| ui/palette_management.py | 41 | `group_indices: list` | `group_indices: List[int]` |
| ui/palette_management.py | 850 | `group_indices: list` | `group_indices: List[int]` |
| ui/palette_management.py | 873 | `group_indices: list` | `group_indices: List[int]` |
| ui/palette_management.py | 886 | `batch_data: list` | `batch_data: List[dict]` |
| ui/palette_management.py | 1120 | `groups: list` | `groups: List[dict]` |
| ui/palette_management.py | 1211 | `palettes: list` | `palettes: List[dict]` |
| core/palette_service.py | 149 | `palettes: list` | `palettes: List[dict]` |
| core/palette_service.py | 302 | `palettes: list` | `palettes: List[dict]` |
| core/palette_service.py | 316 | `palettes: list` | `palettes: List[dict]` |
| core/preview_service.py | 312 | `-> list[str]:` | `-> List[str]:` |

#### 1.2 使用 `dict` 而非 `Dict`（21处）

**示例问题 - `ui/main_window.py` 第459行：**

```python
# 修改前
def _on_preset_color_favorite(self, favorite_data: dict):

# 修改后
from typing import Dict
def _on_preset_color_favorite(self, favorite_data: Dict[str, Any]):
```

**示例问题 - `core/config.py` 第352行：**

```python
# 修改前
def update_favorite_color(self, favorite_id: str, color_index: int, color_info: dict) -> bool:

# 修改后
from typing import Dict
def update_favorite_color(self, favorite_id: str, color_index: int, color_info: Dict[str, Any]) -> bool:
```

**完整列表：**

| 文件路径 | 行号 | 当前代码 | 优化后代码 |
|---------|------|---------|-----------|
| ui/main_window.py | 459 | `favorite_data: dict` | `favorite_data: Dict[str, Any]` |
| ui/main_window.py | 473 | `preview_data: dict` | `preview_data: Dict[str, Any]` |
| core/config.py | 352 | `color_info: dict` | `color_info: Dict[str, Any]` |
| core/config.py | 376 | `palette_data: dict` | `palette_data: Dict[str, Any]` |
| ui/color_preview.py | 377 | `scene_config: dict` | `scene_config: Dict[str, Any]` |
| ui/color_preview.py | 418 | `config: dict` | `config: Dict[str, Any]` |
| ui/color_preview.py | 438 | `_registry: dict` | `_registry: Dict[str, Type[BasePreviewScene]]` |
| ui/color_preview.py | 454 | `scene_config: dict` | `scene_config: Dict[str, Any]` |
| ui/color_preview.py | 512 | `scene_config: dict = None` | `scene_config: Optional[Dict[str, Any]] = None` |
| ui/color_preview.py | 781 | `config: dict` | `config: Dict[str, Any]` |
| ui/preset_color.py | 255 | `palette_data: dict` | `palette_data: Dict[str, Any]` |
| ui/preset_color.py | 786 | `preview_data: dict` | `preview_data: Dict[str, Any]` |
| ui/palette_management.py | 467 | `favorite_data: dict` | `favorite_data: Dict[str, Any]` |
| ui/palette_management.py | 635 | `color_info: dict` | `color_info: Dict[str, Any]` |
| ui/palette_management.py | 969 | `color_info: dict` | `color_info: Dict[str, Any]` |
| ui/palette_management.py | 1483 | `color_info: dict` | `color_info: Dict[str, Any]` |
| ui/luminance_extract.py | 76 | `result: dict` | `result: Dict[str, Any]` |
| dialogs/edit_palette.py | 138 | `color_info: dict` | `color_info: Dict[str, Any]` |
| core/luminance_service.py | 285 | `result: dict` | `result: Dict[str, Any]` |
| core/palette_service.py | 361 | `palette: dict` | `palette: Dict[str, Any]` |
| core/color_data.py | 10 | `json_data: dict` | `json_data: Dict[str, Any]` |

#### 1.3 使用 `tuple` 而非 `Tuple`（5处）

**示例问题 - `core/cache_base.py` 第44行：**

```python
# 修改前
def _get_from_cache(self, key: tuple) -> Optional[Any]:

# 修改后
from typing import Tuple
def _get_from_cache(self, key: Tuple) -> Optional[Any]:
```

**完整列表：**

| 文件路径 | 行号 | 当前代码 | 优化后代码 |
|---------|------|---------|-----------|
| core/cache_base.py | 44 | `key: tuple` | `key: Tuple` |
| core/cache_base.py | 62 | `key: tuple` | `key: Tuple` |
| ui/color_wheel.py | 446 | `-> tuple:` | `-> Tuple[float, float]:` |
| ui/color_wheel.py | 471 | `-> tuple:` | `-> Tuple[float, float, float]:` |
| ui/color_wheel.py | 495 | `-> tuple:` | `-> Tuple[int, int]:` |

---

### 问题二：缺少返回类型注解

#### 2.1 公共方法缺少返回类型（节选示例）

**示例 - `ui/settings.py` 第39行：**

```python
# 修改前
def __init__(self, parent=None):

# 修改后
def __init__(self, parent=None) -> None:
```

**示例 - `ui/settings.py` 第604行：**

```python
# 修改前
def is_hex_visible(self):
    return self._hex_visible

# 修改后
def is_hex_visible(self) -> bool:
    return self._hex_visible
```

**示例 - `ui/color_preview.py` 第1325行：**

```python
# 修改前
def get_scene_type_config(self, scene_id: str) -> Optional[dict]:

# 修改后
from typing import Dict
def get_scene_type_config(self, scene_id: str) -> Optional[Dict[str, Any]]:
```

---

### 问题三：其他类型注解问题

#### 3.1 使用 `type` 而非 `Type`

**示例 - `ui/color_preview.py` 第441行：**

```python
# 修改前
def register(cls, scene_type: str, scene_class: type):

# 修改后
from typing import Type
def register(cls, scene_type: str, scene_class: Type[BasePreviewScene]) -> None:
```

#### 3.2 Python 3.9+ 语法兼容性问题

**示例 - `core/preview_service.py` 第312行：**

```python
# 修改前（Python 3.9+ 语法）
def extract_hex_colors_from_favorite(self, favorite: dict) -> list[str]:

# 修改后（兼容旧版本）
from typing import Dict, List
def extract_hex_colors_from_favorite(self, favorite: Dict[str, Any]) -> List[str]:
```

---

## 优化实施步骤

### 第一阶段：修复核心模块（高优先级）

1. **core/color.py** - 修复 `list` 类型
2. **core/config.py** - 修复 `list` 和 `dict` 类型
3. **core/cache_base.py** - 修复 `tuple` 类型
4. **core/palette_service.py** - 修复 `list` 和 `dict` 类型
5. **core/preview_service.py** - 修复 Python 3.9+ 语法
6. **core/luminance_service.py** - 修复 `dict` 类型
7. **core/color_data.py** - 修复 `dict` 类型

### 第二阶段：修复 UI 模块（中优先级）

1. **ui/color_wheel.py** - 修复 `list` 和 `tuple` 类型
2. **ui/canvases.py** - 修复 `list` 类型
3. **ui/main_window.py** - 修复 `list` 和 `dict` 类型
4. **ui/color_preview.py** - 修复 `list`、`dict` 和 `type` 类型
5. **ui/preset_color.py** - 修复 `list` 和 `dict` 类型
6. **ui/palette_management.py** - 修复 `list` 和 `dict` 类型
7. **ui/luminance_extract.py** - 修复 `dict` 类型
8. **ui/settings.py** - 添加返回类型注解
9. **ui/color_extract.py** - 添加返回类型注解

### 第三阶段：修复对话框模块（低优先级）

1. **dialogs/edit_palette.py** - 修复 `dict` 类型

---

## 验收标准

- [ ] 所有 `list` 改为 `List`
- [ ] 所有 `dict` 改为 `Dict`
- [ ] 所有 `tuple` 改为 `Tuple`
- [ ] 所有 `type` 改为 `Type`
- [ ] 移除 Python 3.9+ 内置泛型语法，统一使用 typing 模块
- [ ] 核心模块的公共方法添加返回类型注解
- [ ] 代码符合开发规范中的代码编写规范（第3章）

---

## 涉及文件清单

### 核心模块（core/）
- [ ] core/color.py
- [ ] core/config.py
- [ ] core/cache_base.py
- [ ] core/palette_service.py
- [ ] core/preview_service.py
- [ ] core/luminance_service.py
- [ ] core/color_data.py

### UI 模块（ui/）
- [ ] ui/color_wheel.py
- [ ] ui/canvases.py
- [ ] ui/main_window.py
- [ ] ui/color_preview.py
- [ ] ui/preset_color.py
- [ ] ui/palette_management.py
- [ ] ui/luminance_extract.py
- [ ] ui/settings.py
- [ ] ui/color_extract.py

### 对话框模块（dialogs/）
- [ ] dialogs/edit_palette.py

---

## 计划制定日期

2026-02-21
