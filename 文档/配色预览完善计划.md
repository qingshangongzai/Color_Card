# 配色预览功能完善计划

## 功能概述

配色预览功能允许用户在独立的预览面板中查看收藏的配色方案在不同场景下的应用效果。该功能已初步实现，但存在一些需要完善的问题。

---

## 已实现功能

### 1. 基础组件
- **DraggableColorDot**: 可拖拽的颜色圆点组件 ✅
- **ColorDotBar**: 颜色圆点工具栏，支持拖拽排序 ✅（已修复，带视觉反馈）
- **IllustrationPreview**: 插画风格预览（使用 QPainter 绘制植物风格矢量图）
- **TypographyPreview**: 排版风格预览（展示文字排版效果）
- **PreviewToolbar**: 预览工具栏（包含圆点栏和场景选择器）
- **MixedPreviewPanel**: Mixed场景预览面板（2x2小图 + 右侧大图）

### 2. 界面集成
- **ColorPreviewInterface**: 配色预览主界面
- 已集成到主窗口导航栏
- 支持从色彩管理页面跳转

### 3. 联动功能
- 色彩管理页面每个配色方案卡片添加了"预览"按钮
- 点击后自动跳转到配色预览页面并加载对应配色
- 支持实时刷新收藏列表

---

## 已知问题

### 问题1：拖拽排序功能异常 ✅ 已修复

**现象描述：**
- 颜色圆点可以拖动
- 但无法正确切换排序位置
- 拖拽结束后圆点顺序没有按预期改变

**修复内容：**
1. 使用 Qt 原生拖拽机制 (`QDrag` + `dropEvent`) 替代自定义信号机制
2. 在 `ColorDotBar` 中实现完整的拖放处理逻辑
3. 添加插入指示器视觉反馈（发光圆点 + 延伸线）
4. 优化索引计算逻辑，支持插入到任意位置

**相关代码位置：**
```python
# ui/preview_widgets.py
- DraggableColorDot: 简化拖拽逻辑，使用 QDrag 机制
- ColorDotBar: 实现 dragEnterEvent/dragMoveEvent/dropEvent
- ColorDotBar._calculate_insert_index(): 计算插入位置
- ColorDotBar.paintEvent(): 绘制插入指示器
```

---

### 问题2：预览场景切换未实现 ✅ 已修复

**现象描述：**
- 场景选择器（Mixed/UI/Web/Brand/Illustration/排版/海报/图案）已显示
- 但切换场景后预览内容没有变化
- 目前始终显示 Mixed 场景

**修复内容：**
1. ✅ 创建 `ConfigurablePreviewScene` 类，从配置加载场景定义
2. ✅ 创建 `SceneRenderer` 通用场景渲染器
3. ✅ 修改 `MixedPreviewPanel.set_scene()` 支持配置化场景切换
4. ✅ UI、Web、Illustration、Typography 场景使用配置化渲染

---

### 问题3：右键菜单功能缺失 ✅ 已完成

**现象描述：**
- 右键点击颜色圆点无响应
- 无法快速查看颜色详细信息
- 无法通过右键菜单进行删除等操作

**修复内容：**
1. ✅ 在 `DraggableColorDot` 上实现 `contextMenuEvent` 方法
2. ✅ 创建 Fluent 风格的右键菜单，包含：
   - HEX值显示（如 `#1F628D`）和复制功能
   - 删除颜色选项
3. ✅ HEX值显示由设置菜单统一控制

**⚠️ 说明：**
- 其他功能（颜色色块预览、完整色彩信息 HSB/LAB 等）暂不需要，当前实现已满足基本需求
- 右键菜单与左键点击排序功能互不冲突

---

### 问题4：不支持对单个色彩进行删除 ✅ 已完成

**现象描述：**
- 颜色圆点栏显示当前配色方案的所有颜色
- 用户无法删除不需要的颜色
- 只能查看，无法编辑颜色列表

**修复内容：**
1. ✅ 在右键菜单中添加"删除"选项
2. ✅ 在 `ColorDotBar` 中实现 `delete_color(index)` 方法
3. ✅ 删除后自动更新预览区域

**⚠️ 兼容性说明：**
- 删除功能通过右键菜单实现，与左键点击排序功能无冲突

---

### 问题5：场景配置化 ✅ 已完成

**现象描述：**
- 场景列表硬编码在代码中
- 新增场景需要修改代码
- 无法方便地分享和导入自定义场景

**修复内容：**
1. ✅ 创建场景配置系统
   - `preview_scenes/scenes.json` - 内置场景配置文件
   - `preview_scenes/user_scenes/` - 用户自定义场景目录
2. ✅ 创建 `SceneConfigManager` 类管理场景配置
   - 加载内置场景和用户场景
   - 支持场景的导入/导出
   - 支持用户自定义场景的增删改查
3. ✅ 创建 `BasePreviewScene` 基类和 `PreviewSceneFactory` 工厂
   - 统一场景接口
   - 支持动态创建场景实例
4. ✅ 修改 `PreviewSceneSelector` 从配置加载场景列表
   - 动态读取场景配置
   - 支持场景列表热更新

**相关代码位置：**
```python
# core/config.py
- SceneConfigManager: 场景配置管理器
- get_scene_config_manager(): 获取全局实例

# ui/preview_widgets.py
- BasePreviewScene: 场景基类
- PreviewSceneFactory: 场景工厂
- PreviewSceneSelector: 场景选择器（从配置加载）

# preview_scenes/scenes.json
- 内置场景配置文件

# preview_scenes/user_scenes/
- 用户自定义场景目录
```

**配置格式示例：**
```json
{
  "id": "ui",
  "name": "UI Design - UI设计",
  "type": "configurable",
  "description": "手机应用界面预览",
  "icon": "phone",
  "builtin": true,
  "config": {
    "frame": {
      "width_ratio": 0.6,
      "height_ratio": 0.5,
      "margin": 6,
      "border_radius": 20
    },
    "status_bar": {
      "height": 30,
      "border_radius": 12,
      "text": "9:41",
      "color_idx": 1
    }
  }
}
```

---

## 场景实现状态

| 场景 | 预览内容 | 状态 | 优先级 |
|------|---------|:---:|:---:|
| Custom | SVG自定义预览（支持导入导出） | ✅ 已实现 | 高 |
| Mixed | 2x2插画小图 + 排版大图 | ✅ 已实现 | 高 |
| UI Design | 手机界面预览（配置化） | ✅ 已实现 | 高 |
| Web | 网页布局预览（配置化） | ✅ 已实现 | 高 |
| Illustration | 植物风格插画预览（配置化） | ✅ 已实现 | 高 |
| Typography | 文字排版预览（配置化） | ✅ 已实现 | 高 |
| Brand | 品牌设计预览（配置化） | ✅ 已实现 | 中 |
| Poster | 海报设计预览（配置化） | ✅ 已实现 | 低 |
| Pattern | 图案纹理预览（配置化） | ✅ 已实现 | 低 |
| Magazine | 杂志排版预览（配置化） | ✅ 已实现 | 低 |

**说明：**
- ✅ 已实现：功能完整，从 JSON 配置加载
- ❌ 待实现：需要创建新的场景配置

---

## 优化建议

### 1. 拖拽排序优化 ✅ 已完成
- ✅ 添加拖拽时的视觉反馈（发光圆点 + 延伸线指示器）
- 支持动画过渡效果
- ✅ 使用 `QDrag` 和 `dropEvent` 标准拖拽机制

### 2. 预览面板优化
- 添加缩放功能，支持查看细节
- 支持导出预览图为图片
- 添加更多预设的插画样式（不仅限于植物）
- **✅ 新增 SVG 导入功能**：支持用户导入从 Illustrator 导出的 SVG 插画文件
  - 使用 Qt 的 QSvgRenderer 解析 SVG
  - 智能配色识别：自动识别 SVG 中的配色区域（背景、主体、装饰、文字等）
  - 支持智能配色映射模式（基于面积）
  - 支持 CSS 类样式解析（Illustrator 导出的 SVG 常用格式）
  - 检测 SVG 是否有背景元素，为透明背景自动添加背景矩形
  - 提供示例 SVG 模板，帮助用户理解如何命名元素
  - 完全符合 GPL3 协议（SVG 是开放标准）
  - **✅ 场景配置化**：支持通过 JSON 配置文件定义和扩展场景
  - 内置场景配置：`preview_scenes/scenes.json`
  - 用户自定义场景目录：`preview_scenes/user_scenes/`
  - 支持场景的导入/导出功能

### 3. 交互优化
- 在色彩管理页面，预览按钮添加悬停提示
- 配色预览页面添加"返回色彩管理"按钮
- 支持键盘快捷键切换场景
- ✅ **支持对单个色彩进行删除**：通过右键菜单删除颜色
- ✅ **右键点击色块显示HEX值**：右键点击颜色圆点时，显示HEX值并支持复制

### 4. 性能优化
- 缓存绘制好的预览图，避免重复绘制
- 延迟加载非当前场景的预览面板

---

## 文件结构

```
core/
├── config.py                   # 配置管理（✅ 新增 SceneConfigManager）
└── ...

preview_scenes/                 # ✅ 场景配置目录（新增）
├── scenes.json                 # 内置场景配置
└── user_scenes/                # 用户自定义场景

ui/
├── preview_widgets.py          # 预览相关组件
│   ├── DraggableColorDot       # 可拖拽颜色圆点
│   ├── ColorDotBar             # 颜色圆点栏（✅ 已修复拖拽排序）
│   ├── BasePreviewScene        # ✅ 场景基类（新增）
│   ├── PreviewSceneFactory     # ✅ 场景工厂（新增）
│   ├── SceneRenderer           # ✅ 通用场景渲染器（新增）
│   ├── ConfigurablePreviewScene # ✅ 配置化场景（新增）
│   ├── IllustrationPreview     # 插画预览（Mixed场景专用，待配置化）
│   ├── TypographyPreview       # 排版预览（Mixed场景专用，待配置化）
│   ├── SVGPreviewWidget        # ✅ SVG预览组件（新增）
│   ├── PreviewSceneSelector    # 场景选择器（✅ 从配置加载）
│   ├── MixedPreviewPanel       # Mixed场景面板（✅ 支持动态场景）
│   └── PreviewToolbar          # 预览工具栏
│
├── interfaces.py               # 界面类
│   └── ColorPreviewInterface   # 配色预览界面（✅ 场景切换已完善）
│
├── color_management_widgets.py # 色彩管理组件
│   ├── ColorManagementSchemeCard    # 配色方案卡片（已添加预览按钮）
│   └── ColorManagementSchemeList    # 配色方案列表
│
└── main_window.py              # 主窗口
    └── show_color_preview()    # 跳转到配色预览页面
```

---

## 下一步行动

### 已完成 ✅
1. **修复拖拽排序功能**（✅ 已完成）
   - 调试 `ColorDotBar` 类的拖拽逻辑
   - 修复索引计算问题
2. **实现右键菜单功能**（✅ 已完成）
   - 在 `DraggableColorDot` 上实现 `contextMenuEvent` 方法
   - 创建 Fluent 风格的右键菜单，包含 HEX 值显示/复制和删除选项
   - HEX 值显示由设置菜单统一控制
3. **实现单个色彩删除功能**（✅ 已完成）
   - 通过右键菜单删除颜色
   - 在 `ColorDotBar` 中实现 `delete_color(index)` 方法
   - 删除后自动更新预览区域
4. **实现场景切换功能**（✅ 已完成）
   - 创建 `ConfigurablePreviewScene` 和 `SceneRenderer` 类
   - 实现场景配置化系统
   - 修改 `MixedPreviewPanel.set_scene()` 支持配置化场景
5. **SVG 导入功能优化**（✅ 已完成）
   - - 智能识别 SVG 中的配色区域（背景、主体、装饰、文字等）
   - 支持智能配色映射模式（基于面积）
   - 支持 CSS 类样式解析（Illustrator 导出的 SVG 常用格式）
   - 检测 SVG 是否有背景元素，为透明背景自动添加背景矩形
   - 实现 `core/svg_color_mapper.py` 核心模块
6. **场景完全配置化**（✅ 已完成）
   - 将 UI、Web、Illustration、Typography 场景的配置提取到 JSON
   - 创建通用的场景渲染器 `SceneRenderer`
   - 创建配置化场景类 `ConfigurablePreviewScene`
   - 删除废弃的 `MobileUIPreview` 和 `WebPreview` 类
7. **完善剩余场景**（✅ 已完成）
   - 新增 Brand（品牌）场景：Logo展示、名片设计、品牌色应用
   - 新增 Poster（海报）场景：海报布局、标题/副标题/装饰元素
   - 新增 Pattern（图案）场景：几何图案重复、纹理效果
   - 新增 Magazine（杂志排版）场景：大标题、副标题、正文段落、引用块
   - 所有新场景完全配置化，从 `scenes.json` 加载
8. **清理硬编码文本**（✅ 已完成）
   - UI/Web 场景中的文本（"首页"、"项目"、"功能"等）改为从配置读取
   - `SceneRenderer.draw_empty_hint()` 支持自定义提示文本
   - 所有用户可见文本均可通过 `scenes.json` 配置

### 待实现 📝

#### 1. Mixed场景配置化（中优先级）
- **目标**：将 Mixed 场景从固定实现改为配置化
- **当前问题**：
  - `IllustrationPreview` 和 `TypographyPreview` 是硬编码的专用组件
  - 插画样式、文本内容、布局参数无法通过配置修改
- **建议方案**：
  - 在 `scenes.json` 中添加 mixed 场景的完整配置
  - 支持配置插画类型（植物/几何/抽象等）
  - 支持配置排版文本内容、字体、布局
  - 支持配置 2x2 网格的布局参数（间距、圆角等）
  - 重构 `MixedPreviewPanel` 从配置加载场景定义
- **相关代码位置**：
  ```python
  # ui/preview_widgets.py
  - MixedPreviewPanel: 重构为配置化渲染
  - IllustrationPreview: 支持配置化绘制参数
  - TypographyPreview: 支持配置化文本和样式
  
  # preview_scenes/scenes.json
  - 添加 mixed 场景配置
  ```

#### 2. 测试和优化（中优先级）
- 测试各种配色数量（2-5色）的显示效果
- 优化绘制性能
- 测试配置化场景的边界情况

---

## 备注

- 所有修改应遵循项目的开发规范（`文档/开发规范.md`）
- 保持代码风格与现有代码一致
- 添加适当的文档字符串和注释
- **代码清理已完成**：
  - 删除了废弃的 `MobileUIPreview` 和 `WebPreview` 类，减少了约 400 行冗余代码
  - 删除了残留的 `set_mapping_mode_visible` 方法和 `svg_mapping_mode` 配置项
- **当前状态**：10个场景中，8个已完全配置化（custom/svg + 6个configurable），Mixed场景待配置化
- **重构计划**：详见 `配色预览重构计划.md`
