# 主题色提取逻辑说明

## 概述

本文档说明色彩提取功能中"自动提取主题色"的实现逻辑，解释为什么采样点位置的颜色可能与提取的主题色不一致。

---

## 算法流程

### 1. 主色调提取 (MMCQ算法)

**文件**: `core/color.py` → `extract_dominant_colors()`

```
输入: 图片 + 提取数量(默认5)
  ↓
采样像素 (sample_step=4，即每4个像素采样一次)
  ↓
MMCQ中位切分量化
  - 将颜色空间划分为多个立方体
  - 递归切分体积最大的立方体
  - 直到达到目标颜色数量
  ↓
输出: 主色调列表 [(r,g,b), ...]
```

**MMCQ算法特点**:
- 提取的是**代表性颜色**，即颜色空间的聚类中心
- 这个颜色是计算得出的平均值，图片中可能没有像素精确匹配

### 2. 位置查找

**文件**: `core/color.py` → `find_dominant_color_positions()`

```
输入: 图片 + 主色调列表
  ↓
对每个像素:
  - 计算该像素到每个主色调的RGB距离
  - 将像素分配给距离最近的主色调
  ↓
对每个主色调:
  - 计算所有属于该颜色的像素的重心位置 (平均值)
  - rel_x = avg_x / width
  - rel_y = avg_y / height
  ↓
输出: 相对坐标列表 [(rel_x, rel_y), ...]
```

---

## 关键理解

### 为什么采样点位置的颜色 ≠ 提取的主题色？

这是**算法的正常特性**，不是bug。

| 概念 | 说明 | 类比 |
|------|------|------|
| **提取的主题色** | 该区域的代表性颜色（聚类中心） | 一群人的平均身高 |
| **采样点位置** | 该颜色在图片中的重心位置 | 这群人的中心位置 |
| **实际像素颜色** | 该位置的真实颜色 | 中心位置那个人的实际身高 |

**核心逻辑**:
1. 算法找到一个"蓝色区域"
2. 计算这个区域内所有像素的平均颜色 → `#1F4B68`
3. 计算这个区域的重心位置 → `(rel_x, rel_y)`
4. 但重心位置的实际像素可能是 `#2A5A7A`

**原因**:
- 区域内像素颜色分布: `#2A5A7A`, `#1E4A66`, `#3B6B8C`, `#204C69`...
- 平均值是 `#1F4B68`，但单个像素可能都不等于这个值

---

## 代码实现细节

### 调用链

```
ui/color_extract.py
  _on_extract_dominant_clicked()
    ↓
core/color_service.py
  ColorService.extract_dominant_colors()
    ↓
  DominantColorExtractor (子线程)
    ↓
core/color.py
  extract_dominant_colors()      # 提取主色调
  find_dominant_color_positions() # 查找位置
    ↓
  信号: extraction_finished(dominant_colors, positions)
    ↓
ui/color_extract.py
  _on_extraction_finished()
    ↓
ui/canvases.py
  ImageCanvas.set_picker_positions_by_colors()
    - 更新采样点位置
    - 提取采样点处的实际颜色
```

### 关键代码

**提取主色调**:
```python
# core/color.py:1068-1104
def extract_dominant_colors(image, count=5, sample_step=4):
    pixels = _extract_pixels_fast(image, sample_step)
    cubes = _mmcq_quantize(pixels, count)
    cubes.sort(key=lambda c: c.get_count(), reverse=True)
    dominant_colors = [cube.get_average_color() for cube in cubes]
    return dominant_colors
```

**查找位置**:
```python
# core/color.py:1191-1280
def find_dominant_color_positions(image, dominant_colors, sample_step=4):
    width, height, pixel_data = _extract_pixels_with_positions_fast(image, sample_step)
    
    # 将每个像素归类到最接近的主色调
    for x, y, r, g, b in pixel_data:
        min_distance = float('inf')
        closest_color_index = 0
        for i, (dr, dg, db) in enumerate(dominant_colors):
            distance = ((r - dr) ** 2 + (g - dg) ** 2 + (b - db) ** 2) ** 0.5
            if distance < min_distance:
                min_distance = distance
                closest_color_index = i
        color_clusters[closest_color_index].append((x, y))
    
    # 计算每种颜色的重心位置
    positions = []
    for cluster in color_clusters:
        if cluster:
            avg_x = sum(p[0] for p in cluster) / len(cluster)
            avg_y = sum(p[1] for p in cluster) / len(cluster)
            positions.append((avg_x / width, avg_y / height))
    
    return positions
```

---

## 设计合理性

当前设计的优势:

| 方面 | 说明 |
|------|------|
| **提取的颜色** | 是该区域的"代表色"，视觉上最准确 |
| **采样点位置** | 是该颜色在图片中的"重心位置"，位置最准确 |
| **两者组合** | 给用户提供了最佳信息：颜色是什么 + 颜色在哪里 |

如果强制采样点位置的颜色等于提取的主题色:
- 可能导致采样点被推到图片边缘
- 或推到不重要的位置
- 失去"重心位置"的语义

---

## 相关文件

- `core/color.py` - 颜色处理和MMCQ算法实现
- `core/color_service.py` - 颜色服务，管理提取任务
- `ui/color_extract.py` - 色彩提取界面
- `ui/canvases.py` - 画布组件，采样点管理

---

## 总结

- **这不是bug**，是聚类算法的正常特性
- 提取的主题色是"代表性颜色"
- 采样点位置是该颜色的"重心位置"
- 两者共同为用户提供完整信息
