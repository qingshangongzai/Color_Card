# Color Card 重构计划

**制定日期**: 2026-02-17  
**项目**: Color Card (取色卡)

---

## 核心原则

**UI层和业务层分层，公共模块统一管理，业务模块按需调用；UI层只负责UI，功能层面全部下到业务层**

```
重构前（混合架构）                    重构后（分层架构）
┌──────────────────┐                ┌─────────────┐     ┌─────────────┐
│  ui/interfaces.py │                │   ui/       │ ←── │   core/     │
│  (UI+逻辑混合)    │                │  (纯界面)   │ 调用 │  (业务服务)  │
└──────────────────┘                └─────────────┘     └─────────────┘
```

---

## 第一阶段：基础设施准备

### 任务 1.1：创建通用异步加载基类 ✅

**目标**：消除多个文件中重复的异步加载线程模式

**文件**：新建 `core/async_loader.py`

**涉及文件**：
- `ui/palette_management_widgets.py` - FavoriteGroupLoaderThread ✅
- `ui/preset_color_widgets.py` - GroupLoaderThread ✅
- ~~`ui/canvases.py` - ImageLoader, ProgressiveImageLoader~~ （ImageLoader 为死代码已删除，ProgressiveImageLoader 不适合分批加载模式）

**实现内容**：
```python
class BaseBatchLoader(QThread):
    batch_ready = Signal(int, list)
    batch_finished = Signal()
    loading_finished = Signal()
    
    # 子类实现 load_batch() 和 get_total_batches()
```

**验收标准**：
- [x] 基类包含取消机制
- [x] 支持批次大小配置
- [x] 至少2个现有线程类改用此基类

**完成日期**：2026-02-17

---

### 任务 1.1.1：图片加载优化 ✅

**目标**：优化大图片加载速度，分离显示和计算

**文件**：修改 `ui/canvases.py`

**优化方案**：
- 阶段1：快速解码显示尺寸图片（默认1920px）→ 立即显示
- 阶段2：后台解码完整图片 → 用于直方图计算和精确取色

**修改内容**：
- `ProgressiveImageLoader` 信号重命名：
  - `blurry_loaded` → `display_ready`
  - `full_loaded` → `full_ready`
- 参数变更：`blurry_size` → `display_size`（默认1920px）
- 方法重命名：`_setup_blurry_preview` → `_setup_display_preview`

**验收标准**：
- [x] 大图片（>1920px）显示速度提升 50%+
- [x] 直方图精度不降低（仍使用完整图片计算）
- [x] 取色精度不降低（仍使用完整图片取色）
- [x] 取消机制正常工作

**完成日期**：2026-02-17

---

### 任务 1.2：提取通用分组逻辑 ✅

**目标**：消除 `core/config.py` 和 `ui/palette_management_widgets.py` 中重复的分组逻辑

**文件**：新建 `core/grouping.py`

**涉及文件**：
- `core/config.py` - GROUPING_THRESHOLDS
- `ui/palette_management_widgets.py` - _generate_groups()

**实现内容**：
```python
GROUPING_THRESHOLDS = {
    "min_for_groups": 20,
    "group_size": 20,
    "batch_threshold": 50,
    "batch_size": 10
}

def generate_groups(total: int) -> list: ...
def should_use_batch_loading(total: int) -> bool: ...
```

**验收标准**：
- [x] 分组逻辑集中到 `core/grouping.py`
- [x] 原有文件改为导入使用
- [x] 功能测试通过

**完成日期**：2026-02-17

---

### 任务 1.3：创建图片状态中介者 ✅

**目标**：解决图片同步逻辑复杂问题，消除 `_is_clearing` 标志

**文件**：新建 `core/image_mediator.py`

**涉及文件**：
- `ui/main_window.py` - sync_image_data_to_luminance, sync_clear_to_luminance
- `ui/interfaces.py` - ColorExtractInterface, LuminanceExtractInterface
- `ui/canvases.py` - BaseCanvas.clear_image

**实现内容**：
```python
class ImageMediator(QObject):
    image_updated = Signal(object, object, str)  # QPixmap, QImage, source_id
    image_cleared = Signal(str)  # source_id
    
    def set_image(self, pixmap, image, source_id): ...
    def clear_image(self, source_id): ...
    def get_current_image(self) -> tuple: ...
```

**清空同步规范**：
界面类应提供 `clear_all(emit_signal=True)` 方法统一处理所有清空操作：
```python
def clear_all(self, emit_signal: bool = True):
    """清空所有相关内容"""
    self.image_canvas.clear_image(emit_signal)
    self.color_card_panel.clear_all()
    self.hsb_color_wheel.clear_sample_points()
    self.rgb_histogram_widget.clear()
    self.hue_histogram_widget.clear()
```

**验收标准**：
- [x] 图片状态统一由中介者管理
- [x] 消除 main_window 中的 `_is_clearing` 标志
- [x] ImageCanvas 和 LuminanceCanvas 通过中介者同步
- [x] 添加 `clear_all()` 统一清空方法，避免同步时遗漏组件
- [x] 通过 `emit_signal` 参数防止循环同步

**完成日期**：2026-02-17

---

## 第二阶段：UI层瘦身（高优先级）

### 任务 2.1：拆分 interfaces.py 并合并功能模块

**目标**：将 1600 行的 `interfaces.py` 拆分并与对应 `*_widgets.py` 合并

**当前文件**：`ui/interfaces.py`（约1600行，7个界面类）

**拆分方案**：

| 原界面类 | 合并到 | 新文件名 |
|---------|--------|---------|
| ColorExtractInterface | - | `ui/color_extract.py` |
| LuminanceExtractInterface | - | `ui/luminance_extract.py` |
| ColorGenerationInterface | generation_widgets.py | `ui/color_generation.py` |
| PaletteManagementInterface | palette_management_widgets.py | `ui/palette_management.py` |
| PresetColorInterface | preset_color_widgets.py | `ui/preset_color.py` |
| ColorPreviewInterface | preview_widgets.py | `ui/color_preview.py` |
| SettingsInterface | - | `ui/settings.py` |

**执行步骤**：

1. **ColorExtractInterface → color_extract.py** ✅
   - [x] 提取 ColorExtractInterface 类
   - [x] 移动相关私有方法（_on_favorite_clicked、_on_extract_dominant_clicked 等）
   - [x] 更新 main_window.py 导入
   - [x] 清理未使用的导入和属性
   - **完成日期**: 2026-02-17

2. **LuminanceExtractInterface → luminance_extract.py** ✅
   - [x] 提取 LuminanceExtractInterface 类
   - [x] 移动相关私有方法
   - [x] 更新 main_window.py 导入
   - **完成日期**: 2026-02-17

3. **ColorGenerationInterface + generation_widgets.py → color_generation.py** ✅
   - [x] 合并两个文件内容
   - [x] 按功能区域用注释分隔
   - [x] 删除原 generation_widgets.py
   - **完成日期**: 2026-02-17

4. **PaletteManagementInterface + palette_management_widgets.py → palette_management.py** ✅
   - [x] 合并两个文件内容
   - [x] 删除原 palette_management_widgets.py
   - **完成日期**: 2026-02-17

5. **PresetColorInterface + preset_color_widgets.py → preset_color.py** ✅
   - [x] 合并两个文件内容
   - [x] 删除原 preset_color_widgets.py
   - **完成日期**: 2026-02-17

6. **ColorPreviewInterface + preview_widgets.py → color_preview.py** ✅
   - [x] 合并两个文件内容（约1100行 + 界面类）
   - [x] 按功能区域组织代码结构
   - [x] 删除原 preview_widgets.py
   - [x] 清理未使用的导入（QFontMetrics、SpinBox）
   - **完成日期**: 2026-02-18

7. **SettingsInterface → settings.py** ✅
   - [x] 将 `ui/interfaces.py` 重命名为 `ui/settings.py`
   - [x] 更新 `ui/__init__.py` 导入路径
   - [x] 更新 `ui/main_window.py` 导入路径
   - **完成日期**: 2026-02-18

**验收标准**：
- [x] `interfaces.py` 文件删除（已重命名为 `settings.py`）
- [x] 每个界面类一个独立文件（ColorPreviewInterface 已完成）
- [x] 所有导入路径正确更新
- [x] 功能测试通过

---

### 任务 2.2：整合 preview_widgets.py 到 color_preview.py ✅

**目标**：将预览相关组件整合到单一文件，保持功能内聚

**状态**：已在任务 2.1.6 中完成

**完成日期**：2026-02-18

---

### 任务 2.3：重构 canvases.py 高亮逻辑 ✅

**目标**：合并高饱和度/高明度区域高亮的重复代码

**当前文件**：`ui/canvases.py`

**重复代码**：
- `_generate_high_saturation_pixmap()` vs `_generate_high_brightness_pixmap()`
- `_draw_high_saturation_highlight()` vs `_draw_high_brightness_highlight()`
- `_draw_high_saturation_info()` vs `_draw_high_brightness_info()`

**重构方案**：
```python
def _generate_highlight_pixmap(self, mode: str, threshold: float,
                               display_rect: Tuple[int, int, int, int]) -> Optional[QPixmap]:
    """
    mode: 'saturation' 或 'brightness'
    """
    ...

def _draw_highlight(self, mode: str, painter: QPainter,
                   display_rect: Tuple[int, int, int, int]) -> None:
    ...
```

**附加优化**：
- 提取 `_draw_info_box()` 通用方法到 `BaseCanvas` 基类
- 清理未使用的导入 (`get_tooltip_text_color`)
- 将函数内导入移到文件顶部

**完成日期**：2026-02-18

**验收标准**：
- [x] 高亮逻辑合并为通用函数
- [x] 通过参数控制模式
- [x] 功能测试通过
- [x] 代码行数减少107行（1743行 → 1636行）
- [x] 新增 `_draw_info_box` 通用方法供两个子类使用

---

## 第三阶段：业务逻辑下沉（高优先级）

### 任务 3.1：创建 ColorService ✅

**目标**：将 ColorExtractInterface 中的颜色提取逻辑下沉到业务层

**文件**：新建 `core/color_service.py`

**从 ColorExtractInterface 抽取**：
- 主色调提取算法
- 颜色聚类逻辑
- 颜色转换计算
- DominantColorExtractor 线程类

**实现内容**：
```python
class ColorService(QObject):
    extraction_started = Signal()
    extraction_progress = Signal(int)
    extraction_finished = Signal(list, list)  # dominant_colors, positions
    extraction_error = Signal(str)
    
    def extract_dominant_colors(self, image: QImage, count: int) -> None: ...
    def cancel_extraction(self) -> None: ...
```

**完成内容**：
- ✅ 创建 `core/color_service.py`，包含 `ColorService` 和 `DominantColorExtractor`
- ✅ `ColorService` 管理提取任务生命周期（开始、取消、清理）
- ✅ 通过信号与UI层通信（extraction_started, extraction_finished, extraction_error）
- ✅ `ColorExtractInterface` 移除 `DominantColorExtractor` 类定义
- ✅ `ColorExtractInterface` 使用 `_color_service` 替代直接线程管理
- ✅ 删除未使用的导入（`get_text_color`）
- ✅ 提取重复代码为 `_reset_extract_button()` 方法

**验收标准**：
- [x] ColorExtractInterface 只保留UI逻辑
- [x] 颜色计算全部在 ColorService
- [x] 可独立进行单元测试

**完成日期**：2026-02-18

---

### 任务 3.2：创建 PaletteService

**目标**：将 PaletteManagementInterface 中的导入导出逻辑下沉到业务层

**文件**：新建 `core/palette_service.py`

**从 PaletteManagementInterface 抽取**：
- 配色导入逻辑
- 配色导出逻辑
- 配色验证逻辑

**实现内容**：
```python
class PaletteService(QObject):
    import_started = Signal()
    import_finished = Signal(list)
    export_finished = Signal(str)
    error = Signal(str)
    
    def import_from_file(self, path: str) -> None: ...
    def export_to_file(self, palettes: list, format: str, path: str) -> None: ...
    def validate_palette(self, palette: dict) -> bool: ...
```

**已完成内容**：
- ✅ 新建 `core/palette_service.py` 模块，包含 `PaletteService`、`PaletteImporter`、`PaletteExporter` 类
- ✅ 配色导入逻辑下沉到 `PaletteImporter` 线程
- ✅ 配色导出逻辑下沉到 `PaletteExporter` 线程
- ✅ 配色验证逻辑下沉到 `PaletteService.validate_palette()`
- ✅ `PaletteManagementInterface` 只保留UI逻辑，通过信号与 `PaletteService` 通信
- ✅ 简化 `ConfigManager`，移除 `import_favorites()` 和 `export_favorites()` 方法
- ✅ 清理未使用的导入（`uuid`、`QGridLayout`）
- ✅ 移除未使用的 `mode` 参数

**验收标准**：
- [x] PaletteManagementInterface 只保留UI逻辑
- [x] 文件操作全部在 PaletteService

---

### 任务 3.3：创建 ImageService ✅

**目标**：将图片加载处理逻辑统一到业务层

**文件**：新建 `core/image_service.py`

**从 ImageCanvas, LuminanceCanvas 抽取**：
- 图片加载逻辑
- 图片预处理
- 缩略图生成

**实现内容**：
```python
class ImageService(QObject):
    loading_started = Signal()
    loading_progress = Signal(int)
    image_loaded = Signal(object, object)  # QPixmap, QImage
    thumbnail_ready = Signal(object)
    error = Signal(str)
    
    def load_image_async(self, path: str) -> None: ...
    def generate_thumbnail(self, image: QImage, size: int) -> QPixmap: ...
```

**已完成内容**：
- ✅ 新建 `core/image_service.py` 模块，包含 `ProgressiveImageLoader` 和 `ImageService`
- ✅ `ProgressiveImageLoader` 从 `ui/canvases.py` 迁移到 `core/image_service.py`
- ✅ `ImageService` 管理图片加载任务生命周期（开始、取消、清理）
- ✅ 通过信号与UI层通信（loading_started, loading_progress, image_loaded, error）
- ✅ `BaseCanvas` 使用 `_image_service` 替代直接线程管理
- ✅ 清理未使用的导入（`io`, `PIL.Image`, `QThread`）

**验收标准**：
- [x] 图片加载逻辑集中在 ImageService
- [x] Canvas 类只负责显示

**完成日期**：2026-02-18

---

### 任务 3.4：创建 LuminanceService ✅

**目标**：将明度计算逻辑下沉到业务层

**文件**：新建 `core/luminance_service.py`

**从 LuminanceExtractInterface 抽取**：
- 明度计算
- Zone 分析
- 高亮区域计算

**实现内容**：
```python
class LuminanceService(QObject):
    calculation_started = Signal()
    calculation_finished = Signal(dict)
    
    def calculate_luminance_zones(self, image: QImage) -> dict: ...
    def get_zone_distribution(self, image: QImage) -> list: ...
```

**已完成内容**：
- ✅ 新建 `core/luminance_service.py` 模块，包含 `LuminanceCalculator` 和 `LuminanceService`
- ✅ 明度计算逻辑下沉到 `LuminanceCalculator` 线程
- ✅ Zone 分析逻辑下沉到 `LuminanceService.get_zone_at_position()`
- ✅ 亮度分布统计下沉到 `LuminanceService.get_zone_distribution()`
- ✅ 高亮区域计算下沉到 `LuminanceService.generate_zone_highlight_pixmap()`
- ✅ `LuminanceExtractInterface` 使用 `_luminance_service` 进行明度计算

**验收标准**：
- [x] 明度计算逻辑在 LuminanceService
- [x] LuminanceExtractInterface 只保留UI逻辑

**完成日期**：2026-02-18

---

### 任务 3.5：创建 PreviewService

**目标**：将预览场景管理逻辑下沉到业务层

**文件**：新建 `core/preview_service.py`

**从 ColorPreviewInterface 抽取**：
- 场景配置加载
- 场景数据管理
- SVG 配色映射调用

**实现内容**：
```python
class PreviewService(QObject):
    scenes_loaded = Signal(list)
    scene_applied = Signal(dict)
    error = Signal(str)

    def load_scene_types(self) -> List[Dict[str, Any]]: ...
    def get_scene_config(self, scene_id: str) -> Optional[Dict[str, Any]]: ...
    def get_scene_templates(self, scene_id: str) -> List[Dict[str, Any]]: ...
    def add_user_template(self, scene_id: str, template_path: str) -> Tuple[bool, str]: ...
    def remove_user_template(self, scene_id: str, template_path: str) -> Tuple[bool, str]: ...
    def validate_svg_file(self, file_path: str) -> Tuple[bool, str]: ...
```

**已完成内容**：
- ✅ 新建 `core/preview_service.py` 模块，创建 `PreviewService` 类
- ✅ 场景配置加载逻辑下沉到 `load_scene_types()`, `get_scene_config()`
- ✅ 模板管理逻辑下沉到 `get_scene_templates()`, `add_user_template()`, `remove_user_template()`
- ✅ SVG文件验证逻辑下沉到 `validate_svg_file()`
- ✅ `ColorPreviewInterface` 初始化 `_preview_service`，使用服务层处理业务逻辑
- ✅ `ColorPreviewInterface._on_template_deleted()` 使用 `PreviewService.remove_user_template()`
- ✅ `ColorPreviewInterface._on_import_config()` 使用 `PreviewService.validate_svg_file()` 和 `add_user_template()`
- ✅ 清理未使用的导入

**验收标准**：
- [x] 场景管理逻辑在 PreviewService
- [x] ColorPreviewInterface 只保留UI逻辑

**完成日期**：2026-02-18

---

### 任务 3.5.1：PreviewService 功能扩展（进一步重构）✅

**目标**：将 `color_preview.py` 中剩余的业务逻辑进一步下沉到 `PreviewService`

**背景**：`color_preview.py` 经过任务 3.5 重构后仍有约 2050 行，包含以下可下沉的业务逻辑：

**可下沉内容**：

| 原位置 | 方法/逻辑 | 行数 | 下沉到 |
|:---|:---|:---:|:---|
| `SVGPreviewWidget` | `_add_background_to_svg()` | 55 | `PreviewService.add_background_to_svg()` |
| `SVGPreviewWidget` | `_has_fixed_background_element()` | 26 | `PreviewService.has_fixed_background_element()` |
| `ColorPreviewInterface` | `_load_current_scheme()` 中的颜色转换 | 20 | `PreviewService.extract_hex_colors_from_favorite()` |
| `ColorPreviewInterface` | `_on_export_svg()` 中的文件写入 | 15 | `PreviewService.save_svg_to_file()` |
| `ColorPreviewInterface` | `_on_export_config()` 中的文件名生成 | 5 | `PreviewService.generate_export_filename()` |

**新增方法**：

```python
class PreviewService(QObject):
    # ... 已有方法 ...

    def add_background_to_svg(self, svg_content: str, bg_color: str) -> str:
        """为 SVG 添加背景矩形"""
        ...

    def has_fixed_background_element(self, svg_content: str) -> bool:
        """检查SVG是否有固定颜色的背景元素"""
        ...

    def extract_hex_colors_from_favorite(self, favorite: dict) -> list[str]:
        """从收藏数据中提取 HEX 颜色列表"""
        ...

    def save_svg_to_file(self, svg_content: str, file_path: str) -> Tuple[bool, str]:
        """保存 SVG 内容到文件"""
        ...

    def generate_export_filename(self, prefix: str = "color_card") -> str:
        """生成导出文件名"""
        ...
```

**已完成内容**：
- ✅ 扩展 `PreviewService`，新增 5 个业务方法
- ✅ 删除 `SVGPreviewWidget._add_background_to_svg()` 方法（55 行）
- ✅ 简化 `SVGPreviewWidget._has_fixed_background_element()` 方法（26 行 → 5 行）
- ✅ 简化 `ColorPreviewInterface._load_current_scheme()` 方法（20 行 → 6 行）
- ✅ 简化 `ColorPreviewInterface._on_export_svg()` 方法，使用 `PreviewService.save_svg_to_file()`
- ✅ 简化 `ColorPreviewInterface._on_export_config()` 方法，使用 `PreviewService.generate_export_filename()` 和 `save_svg_to_file()`
- ✅ 删除未使用的导入（`datetime`, `Path`）

**代码行数变化**：

| 文件 | 重构前 | 重构后 | 变化 |
|:---|:---:|:---:|:---:|
| `ui/color_preview.py` | ~2050 行 | ~1850 行 | **-200 行** |
| `core/preview_service.py` | ~230 行 | ~430 行 | +200 行 |

**架构改进**：

重构后 UI 层只负责界面展示，所有业务逻辑（SVG处理、数据转换、文件I/O）都下沉到 `PreviewService`：

```
ColorPreviewInterface (纯UI)
└── PreviewService (业务层)
    ├── 场景配置管理
    ├── 模板管理
    ├── SVG工具方法
    ├── 颜色数据转换
    └── 文件操作方法
```

**验收标准**：
- [x] `PreviewService` 新增 SVG 工具方法
- [x] `PreviewService` 新增配色数据转换方法
- [x] `PreviewService` 新增文件操作方法
- [x] `SVGPreviewWidget` 删除 `_add_background_to_svg()` 方法
- [x] `ColorPreviewInterface` 简化导出方法
- [x] 功能测试通过（SVG导入导出、配色预览）

**完成日期**：2026-02-18

---

### 任务 3.6：直方图计算优化

**目标**：优化直方图计算性能，提升大图片加载体验

**文件**：修改 `core/color.py`、`ui/histograms.py`

**当前问题**：
- 直方图计算在主线程执行，阻塞UI
- 大图片（>4000px）计算耗时 2-3 秒

**优化方案**：

1. **后台线程计算**：
   - 创建 `HistogramCalculator` 工作线程
   - 图片加载完成后异步计算直方图
   - 计算完成后通过信号更新UI

2. **延迟计算**：
   - 图片显示后延迟 500ms 再开始计算
   - 用户可立即看到图片，感知更流畅

3. **采样优化**（可选）：
   - 大图片使用更大的采样步长（step=8）
   - 或使用缩略图计算直方图

**实现内容**：
```python
class HistogramCalculator(QThread):
    """后台直方图计算线程"""
    finished = Signal(list)  # 计算完成信号
    
    def __init__(self, image: QImage, sample_step: int = 4):
        super().__init__()
        self._image = image
        self._sample_step = sample_step
    
    def run(self):
        histogram = calculate_histogram(self._image, self._sample_step)
        self.finished.emit(histogram)
```

**已完成内容**：
- ✅ 新建 `core/histogram_service.py` 模块，包含 `HistogramService` 和 `HistogramCalculator`
- ✅ `HistogramCalculator` 在后台线程执行直方图计算（明度、RGB、色相）
- ✅ `HistogramService` 管理计算任务生命周期，支持取消机制
- ✅ 实现延迟计算（默认500ms），图片显示后立即可见
- ✅ 大图片自动使用更大采样步长（优化后：>20MP用step=6，>8MP用step=5，>4MP用step=4，>1MP用step=3）
- ✅ 通过信号与UI层通信（luminance_histogram_ready, rgb_histogram_ready, hue_histogram_ready）
- ✅ `LuminanceHistogramWidget`、`RGBHistogramWidget`、`HueHistogramWidget` 使用异步计算
- ✅ 清理冗余代码：删除 `HueHistogramWidget._calculate_hue_histogram()` 方法
- ✅ 清理未使用的导入：`colorsys`、`calculate_histogram`、`calculate_rgb_histogram`
- ✅ 修复线程安全问题：图像数据复制、QueuedConnection信号、安全停止机制

**Bug修复记录**：
- 修复 `QThread: Destroyed while thread is still running` 警告
- 修复直方图加载完成前拖动色彩采样点导致的崩溃问题
- 实现 `_safe_stop_calculator()` 方法，安全断开信号并等待线程结束

**验收标准**：
- [x] 直方图计算在后台线程执行
- [x] 图片显示不阻塞
- [x] 大图片加载体验明显改善
- [x] 直方图精度可接受（误差 < 5%）
- [x] 无线程安全警告
- [x] 拖动采样点不崩溃

**完成日期**：2026-02-18

---

### 任务 3.7：场景类型延迟加载优化

**目标**：优化应用启动速度，将场景类型加载延迟到首次使用时

**当前问题**：
- 启动时立即加载所有场景类型（`scene_types.json` + SVG模板）
- 即使用户从不使用"配色预览"功能，也会加载
- 启动时间增加 1-2 秒

**优化方案**：

1. **标签页切换时加载**（推荐）：
   ```python
   class ColorPreviewInterface:
       def __init__(self, parent=None):
           self._scene_types_loaded = False
           
       def on_tab_selected(self):
           """当标签页被选中时调用"""
           if not self._scene_types_loaded:
               self._load_scene_types()
               self._scene_types_loaded = True
   ```

2. **场景选择器首次展开时加载**（备选）：
   ```python
   class SceneTypeSelector:
       def showPopup(self):
           """下拉框展开时加载"""
           if not self._loaded:
               self._load_scene_types()
               self._loaded = True
           super().showPopup()
   ```

**涉及文件**：
- `ui/color_preview.py` - `ColorPreviewInterface`, `SceneTypeSelector`
- `core/config.py` - `SceneTypeManager`

**预期效果**：
| 指标 | 当前 | 优化后 |
|------|------|--------|
| 启动时间 | 2-3秒 | <1秒 |
| 内存占用 | 预加载所有场景 | 按需加载 |

**验收标准**：
- [ ] 启动时不加载场景类型数据
- [ ] 切换到"配色预览"标签页时才加载
- [ ] 首次加载显示加载状态提示
- [ ] 如果用户从不使用预览功能，完全不加载

---

## 第四阶段：代码优化（中优先级）

### 任务 4.1：合并 RYB/RGB 配色生成函数

**目标**：消除 `core/color.py` 中高度重复的 RYB/RGB 配色函数

**当前文件**：`core/color.py`

**重复函数**：
- `generate_monochromatic()` vs `generate_ryb_monochromatic()`
- `generate_analogous()` vs `generate_ryb_analogous()`
- `generate_complementary()` vs `generate_ryb_complementary()`
- 等等...

**重构方案**：
```python
def generate_monochromatic(
    hue: float, 
    count: int = 4, 
    base_saturation: float = 100,
    color_space: str = 'rgb'  # 'rgb' 或 'ryb'
):
    if color_space == 'ryb':
        hue = ryb_hue_to_rgb_hue(hue)
    # 公共逻辑
    ...
```

**验收标准**：
- [ ] 通过参数控制色相转换
- [ ] 函数数量减半
- [ ] 单元测试覆盖

---

### 任务 4.2：消除魔法数字

**目标**：将 `core/color.py` 中的魔法数字定义为常量

**当前代码**：
```python
saturations = [
    base_saturation,
    max(20, base_saturation * 0.75),
    max(20, base_saturation * 0.5),
    max(20, base_saturation * 0.25)
]
brightnesses = [100, 90, 80, 70]
```

**重构方案**：
```python
SATURATION_STEPS = [1.0, 0.75, 0.5, 0.25]
MIN_SATURATION = 20
BRIGHTNESS_STEPS = [100, 90, 80, 70]
```

**验收标准**：
- [ ] 所有魔法数字定义为常量
- [ ] 添加注释说明用途

---

### 任务 4.3：完善异常处理

**目标**：改进 `core/config.py` 中的异常处理

**当前问题**：
```python
except (json.JSONDecodeError, IOError, OSError) as e:
    print(f"加载配置文件失败: {e}")
    # 没有通知用户
```

**重构方案**：
```python
class ConfigLoadError(Exception):
    pass

except (json.JSONDecodeError, IOError, OSError) as e:
    logger.error(f"加载配置文件失败: {e}")
    raise ConfigLoadError(f"无法加载配置文件: {e}") from e
```

**验收标准**：
- [ ] 异常向上传播
- [ ] UI层可捕获并显示错误

---

### 任务 4.4：统一类型注解

**目标**：确保所有函数有完整且正确的类型注解

**当前问题**：
```python
def get_color_info(r: int, g: int, b: int) -> Dict[str, any]:  # any 应为 Any
```

**重构方案**：
```python
from typing import Dict, Any

def get_color_info(r: int, g: int, b: int) -> Dict[str, Any]:
    ...
```

**验收标准**：
- [ ] 使用 mypy 检查通过
- [ ] 所有 `any` 改为 `Any`

---

## 第五阶段：架构优化（低优先级）

### 任务 5.1：创建 ThemeService

**目标**：统一主题管理

**文件**：新建 `core/theme_service.py`

**涉及文件**：
- `ui/theme_colors.py`
- 各界面类的 `_update_styles()` 方法
- `main.py` 中的主题设置

**实现内容**：
```python
class ThemeService(QObject):
    theme_changed = Signal(str)
    
    def get_current_theme(self) -> str: ...
    def set_theme(self, theme: str) -> None: ...
    def get_interface_background_color(self) -> QColor: ...
    def get_card_background_color(self) -> QColor: ...
```

**验收标准**：
- [ ] 主题相关代码集中管理
- [ ] 各界面类通过 ThemeService 获取颜色

---

### 任务 5.2：分离配置管理职责

**目标**：将 ConfigManager 分离为 AppConfig 和 FavoritesManager

**当前文件**：`core/config.py`

**职责分离**：

| 原职责 | 新类 |
|--------|------|
| 应用配置管理 | `AppConfig` |
| 收藏管理 | `FavoritesManager` |
| 导入导出 | `PaletteService` |

**验收标准**：
- [ ] ConfigManager 职责单一
- [ ] 收藏功能独立管理

---

### 任务 5.3：合并数据目录

**目标**：将分散的数据目录合并

**当前结构**：
```
color_data/     # 配色JSON数据
scenes_data/    # 场景数据
```

**目标结构**：
```
data/
├── color_data/
└── scenes_data/
```

**验收标准**：
- [ ] 数据目录统一
- [ ] 所有引用路径更新

---

### 任务 5.4：移动 theme_colors.py

**目标**：将 `ui/theme_colors.py` 移至 `utils/`

**原因**：纯工具函数，归入 utils

**验收标准**：
- [ ] 文件移动完成
- [ ] 所有导入路径更新

---

## 第六阶段：长期优化

### 任务 6.1：业务服务延迟加载

**目标**：提升启动性能 50%+

**实施范围**：
- `PaletteService` - 配色数据懒加载
- `ImageService` - 图像处理资源按需初始化
- `UpdateService` - 更新检查后台延迟执行

**前置条件**：
- [x] 完成分层架构重构
- [ ] 建立 ServiceFactory 服务工厂
- [ ] 界面层支持加载状态显示

**实现内容**：
```python
class ServiceFactory:
    _instances = {}
    
    @classmethod
    def get_palette_service(cls) -> PaletteService:
        if 'palette' not in cls._instances:
            cls._instances['palette'] = PaletteService()
        return cls._instances['palette']
```

---

### 任务 6.2：Python 3.14t Free-Threading 适配

**目标**：计算性能提升 3-5x

**实施范围**：
- `core/color.py` - 直方图计算并行化
- `ui/canvases.py` - Zone 高亮渲染多线程优化
- `core/color.py` - 批量颜色转换并行化

**前置条件**：
- [x] 完成分层架构重构
- [ ] Python 3.14t 环境部署
- [ ] PySide6 兼容性测试

---

## 重构后目录结构

```
color_card/
├── core/                      # 业务核心（公共模块）
│   ├── __init__.py
│   ├── color.py              # 颜色计算
│   ├── color_data.py         # 配色数据管理
│   ├── color_service.py      # 新增：颜色服务 ✅
│   ├── palette_service.py    # 新增：配色服务
│   ├── image_service.py      # 新增：图片服务
│   ├── luminance_service.py  # 新增：明度服务
│   ├── preview_service.py    # 新增：预览服务
│   ├── theme_service.py      # 新增：主题服务
│   ├── colorblind.py         # 色盲模拟
│   ├── config.py             # 配置管理
│   ├── contrast.py           # 对比度计算
│   ├── svg_color_mapper.py   # SVG配色映射
│   ├── grouping.py           # 新增：通用分组逻辑
│   ├── async_loader.py       # 新增：通用异步加载基类
│   └── image_mediator.py     # 新增：图片状态中介者
│
├── utils/                     # 纯工具（公共模块）
│   ├── __init__.py
│   ├── icon.py
│   ├── platform.py
│   └── theme_colors.py       # 从 ui/ 移入
│
├── dialogs/                   # 对话框（业务模块）
│   ├── __init__.py
│   ├── about_dialog.py
│   ├── colorblind_dialog.py
│   ├── contrast_dialog.py
│   ├── edit_palette.py
│   └── update_dialog.py
│
├── ui/                        # UI模块（业务模块，功能内聚）
│   ├── __init__.py
│   ├── main_window.py        # 主窗口
│   ├── canvases.py           # 画布组件
│   ├── cards.py              # 色卡组件
│   ├── color_picker.py       # 取色器
│   ├── color_wheel.py        # 色轮
│   ├── histograms.py         # 直方图
│   ├── zoom_viewer.py        # 缩放查看器
│   ├── color_extract.py      # 色彩提取界面 ✅
│   ├── luminance_extract.py  # 明度提取界面 ✅
│   ├── color_generation.py   # 配色生成界面 ✅
│   ├── palette_management.py # 配色管理界面 ✅
│   ├── preset_color.py       # 预设色彩界面 ✅
│   ├── color_preview.py      # 配色预览界面
│   └── settings.py           # 设置界面
│
├── data/                      # 数据目录（合并）
│   ├── color_data/           # 配色JSON数据
│   └── scenes_data/          # 场景数据
│
└── main.py
```

---

## 执行顺序建议

```
第一阶段 ──→ 第二阶段 ──→ 第三阶段 ──→ 第四阶段 ──→ 第五阶段 ──→ 第六阶段
基础设施      UI层瘦身     业务逻辑下沉    代码优化      架构优化      长期优化
```

**依赖关系**：
- 第二阶段依赖第一阶段（需要 ImageMediator）
- 第三阶段依赖第二阶段（需要拆分后的界面类）
- 第六阶段依赖前五阶段完成

---

## 验收清单

### 分层架构验收

- [ ] UI层不包含任何业务逻辑
- [ ] UI层不直接进行文件操作
- [ ] core/ 层不导入 ui/ 层任何模块
- [ ] 所有业务逻辑可通过单元测试验证

### 代码质量验收

- [ ] 单文件不超过 800 行
- [ ] 无重复代码（DRY原则）
- [ ] 类型注解完整
- [ ] 异常处理完善
- [ ] 无魔法数字

### 功能验收

- [ ] 所有现有功能正常工作
- [ ] 性能无明显下降
- [ ] 内存使用无明显增加

---

## 任务汇总表

| 阶段 | 任务编号 | 任务名称 | 优先级 |
|------|----------|----------|--------|
| 第一阶段 | 1.1 | 创建通用异步加载基类 | 高 |
| 第一阶段 | 1.1.1 | 图片加载优化 | 高 |
| 第一阶段 | 1.2 | 提取通用分组逻辑 | 高 |
| 第一阶段 | 1.3 | 创建图片状态中介者 | 高 |
| 第二阶段 | 2.1 | 拆分 interfaces.py 并合并功能模块 | 高 |
| 第二阶段 | 2.2 | 整合 preview_widgets.py 到 color_preview.py | 高 ✅ |
| 第二阶段 | 2.3 | 重构 canvases.py 高亮逻辑 | 高 |
| 第三阶段 | 3.1 | 创建 ColorService | 高 ✅ |
| 第三阶段 | 3.2 | 创建 PaletteService | 高 |
| 第三阶段 | 3.3 | 创建 ImageService | 高 |
| 第三阶段 | 3.4 | 创建 LuminanceService | 高 ✅ |
| 第三阶段 | 3.5 | 创建 PreviewService | 高 ✅ |
| 第三阶段 | 3.5.1 | PreviewService 功能扩展 | 高 ✅ |
| 第三阶段 | 3.6 | 直方图计算优化 | 高 ✅ |
| 第三阶段 | 3.6.1 | 直方图代码清理 | 高 ✅ |
| 第四阶段 | 4.1 | 合并 RYB/RGB 配色生成函数 | 中 |
| 第四阶段 | 4.2 | 消除魔法数字 | 中 |
| 第四阶段 | 4.3 | 完善异常处理 | 中 |
| 第四阶段 | 4.4 | 统一类型注解 | 中 |
| 第五阶段 | 5.1 | 创建 ThemeService | 低 |
| 第五阶段 | 5.2 | 分离配置管理职责 | 低 |
| 第五阶段 | 5.3 | 合并数据目录 | 低 |
| 第五阶段 | 5.4 | 移动 theme_colors.py | 低 |
| 第六阶段 | 6.1 | 业务服务延迟加载 | 长期 |
| 第六阶段 | 6.2 | Python 3.14t Free-Threading 适配 | 长期 |
