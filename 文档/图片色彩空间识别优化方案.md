# 图片色彩空间识别优化方案

## 1. 现状分析

### 1.1 当前问题

当前代码在 `core/image_service.py` 中加载图片时，**未处理色彩空间信息**：

```python
with Image.open(self._image_path) as pil_image:
    if pil_image.mode != 'RGB':
        pil_image = pil_image.convert('RGB')  # 直接转换，丢失色彩空间信息
```

**存在的问题：**
- 不读取 ICC 配置文件
- 不识别图片的实际色彩空间
- 假设所有图片都是 sRGB，导致非 sRGB 图片的直方图计算偏差

### 1.2 影响范围

| 功能模块 | 影响程度 | 说明 |
|---------|---------|------|
| 明度直方图 | 高 | 非 sRGB 图片的明度分布计算不准确 |
| RGB 直方图 | 中 | 颜色通道分布可能偏移 |
| 色彩提取 | 中 | 提取的主色调可能偏色 |
| 颜色显示 | 低 | 显示器通常假设 sRGB，影响较小 |

## 2. 技术方案

### 2.1 色彩空间识别流程

```
图片加载
    ↓
读取 Image.info 字典
    ↓
检测 ICC 配置文件
    ↓
是 → 解析 ICC 配置文件 → 识别颜色空间
否 → 检查 EXIF 色彩空间标签
    ↓
记录图片的色彩空间信息
    ↓
直方图计算时根据色彩空间调整
```

### 2.2 需要识别的颜色空间

| 颜色空间 | 常见来源 | 特点 |
|---------|---------|------|
| sRGB | 网页、普通相机 | 标准 gamma ≈ 2.2 |
| Adobe RGB | 专业相机、印刷 | 色域比 sRGB 大 |
| DCI-P3 | 电影、新款显示器 | 色域比 sRGB 大 |
| ProPhoto RGB | 专业摄影后期 | 色域非常大 |
| Display P3 | Apple 设备 | DCI-P3 的变体 |

### 2.3 ICC 配置文件解析

PIL/Pillow 的 `Image.info['icc_profile']` 包含 ICC 配置文件的原始字节数据。

ICC 配置文件头部结构（前 128 字节）：

| 偏移 | 长度 | 字段 | 说明 |
|-----|------|-----|------|
| 0 | 4 | 配置文件大小 | 整个 ICC 文件大小 |
| 4 | 4 | CMM 类型 | 颜色管理模块类型 |
| 8 | 4 | 版本 | ICC 规范版本 |
| 12 | 4 | 设备类 | 'mntr'(显示器)、'scnr'(扫描仪)等 |
| 16 | 4 | 颜色空间 | 'RGB '、'CMYK'、'GRAY'等 |
| 20 | 4 | PCS | 配置文件连接空间，通常是 'XYZ ' |
| 128+ | - | 标签表 | 各种颜色转换标签 |

## 3. 实现方案

### 3.1 新增色彩空间检测模块

建议新建 `core/color_space.py` 模块：

```python
"""色彩空间检测与转换模块

提供图片色彩空间识别和转换功能。
"""
from typing import Optional, Dict, Any
from dataclasses import dataclass
from PIL import Image
import struct


@dataclass
class ColorSpaceInfo:
    """色彩空间信息"""
    name: str                    # 颜色空间名称
    has_icc_profile: bool        # 是否包含 ICC 配置文件
    icc_profile_size: int        # ICC 配置文件大小
    gamma: Optional[float]       # Gamma 值
    source: str                  # 信息来源 ('icc', 'exif', 'default')


class ColorSpaceDetector:
    """色彩空间检测器"""
    
    # 常见 ICC 配置文件的标识
    KNOWN_PROFILES = {
        b'sRGB': 'sRGB',
        b'Adobe RGB': 'Adobe RGB',
        b'ProPhoto': 'ProPhoto RGB',
        # 更多标识...
    }
    
    @classmethod
    def detect(cls, image: Image.Image) -> ColorSpaceInfo:
        """检测图片的色彩空间
        
        Args:
            image: PIL Image 对象
            
        Returns:
            ColorSpaceInfo: 色彩空间信息
        """
        # 1. 检查 ICC 配置文件
        if 'icc_profile' in image.info:
            return cls._detect_from_icc(image.info['icc_profile'])
        
        # 2. 检查 EXIF 色彩空间标签
        exif_colorspace = cls._detect_from_exif(image)
        if exif_colorspace:
            return exif_colorspace
        
        # 3. 默认假设为 sRGB
        return ColorSpaceInfo(
            name='sRGB',
            has_icc_profile=False,
            icc_profile_size=0,
            gamma=2.2,
            source='default'
        )
    
    @classmethod
    def _detect_from_icc(cls, icc_profile: bytes) -> ColorSpaceInfo:
        """从 ICC 配置文件解析色彩空间"""
        try:
            # 解析 ICC 头部
            profile_size = struct.unpack('>I', icc_profile[0:4])[0]
            color_space = icc_profile[16:20].decode('ascii', errors='ignore').strip()
            
            # 尝试识别具体的配置文件
            profile_name = cls._identify_profile_name(icc_profile)
            
            return ColorSpaceInfo(
                name=profile_name or color_space,
                has_icc_profile=True,
                icc_profile_size=profile_size,
                gamma=None,  # 需要从 ICC 解析
                source='icc'
            )
        except Exception:
            return ColorSpaceInfo(
                name='Unknown',
                has_icc_profile=True,
                icc_profile_size=len(icc_profile),
                gamma=None,
                source='icc'
            )
    
    @classmethod
    def _detect_from_exif(cls, image: Image.Image) -> Optional[ColorSpaceInfo]:
        """从 EXIF 信息检测色彩空间"""
        try:
            exif = image._getexif()
            if not exif:
                return None
            
            # EXIF 色彩空间标签 (0xA001)
            colorspace_tag = exif.get(0xA001)
            if colorspace_tag == 1:
                return ColorSpaceInfo(
                    name='sRGB',
                    has_icc_profile=False,
                    icc_profile_size=0,
                    gamma=2.2,
                    source='exif'
                )
            elif colorspace_tag == 0xFFFF:
                return ColorSpaceInfo(
                    name='Uncalibrated',
                    has_icc_profile=False,
                    icc_profile_size=0,
                    gamma=None,
                    source='exif'
                )
        except Exception:
            pass
        return None
```

### 3.2 修改图片加载服务

修改 `core/image_service.py`：

```python
class ProgressiveImageLoader(QThread):
    """分阶段图片加载工作线程"""
    
    # 新增信号：色彩空间信息就绪
    colorspace_ready = Signal(object)  # 参数: ColorSpaceInfo
    
    def run(self) -> None:
        """在子线程中分阶段加载图片"""
        try:
            with Image.open(self._image_path) as pil_image:
                # 1. 检测色彩空间（在转换前）
                colorspace_info = ColorSpaceDetector.detect(pil_image)
                self.colorspace_ready.emit(colorspace_info)
                
                # 2. 保存原始色彩空间信息供后续使用
                self._colorspace_info = colorspace_info
                
                # 3. 转换为 RGB（保持当前逻辑）
                if pil_image.mode != 'RGB':
                    pil_image = pil_image.convert('RGB')
                
                # ... 后续处理
```

### 3.3 直方图计算优化

修改 `core/color.py` 中的明度计算：

```python
def calculate_histogram(image, sample_step: int = 4, 
                       colorspace_info: Optional[ColorSpaceInfo] = None) -> List[int]:
    """计算图片的明度直方图
    
    Args:
        image: QImage 对象
        sample_step: 采样步长
        colorspace_info: 色彩空间信息（可选）
    """
    # 根据色彩空间调整 gamma 值
    gamma = 2.2  # 默认 sRGB gamma
    if colorspace_info:
        if colorspace_info.name == 'Adobe RGB':
            gamma = 2.2  # Adobe RGB 使用不同的 gamma
        elif colorspace_info.gamma:
            gamma = colorspace_info.gamma
    
    # 使用调整后的 gamma 计算明度
    # ...
```

## 4. 实施步骤

### 阶段 1：基础检测（推荐优先实施）

1. 创建 `core/color_space.py` 模块
2. 实现基本的 ICC 配置文件检测
3. 在 `ImageService` 中集成色彩空间检测
4. 在 UI 中显示色彩空间信息（调试用）

### 阶段 2：直方图优化

1. 修改明度计算函数，支持不同色彩空间
2. 根据色彩空间调整 gamma 校正
3. 测试各种颜色空间图片的直方图准确性

### 阶段 3：颜色转换（可选）

1. 使用 `PIL.ImageCms` 进行精确的颜色空间转换
2. 将非 sRGB 图片正确转换到 sRGB 空间
3. 保持原始数据供专业用户使用

## 5. 测试方案

### 5.1 测试图片准备

| 图片类型 | 来源 | 用途 |
|---------|------|------|
| sRGB JPEG | 普通相机/手机 | 验证默认处理 |
| Adobe RGB JPEG | 专业相机 | 验证 ICC 检测 |
| DCI-P3 PNG | 显示器截图 | 验证宽色域处理 |
| 无 ICC 图片 | 网络下载 | 验证默认假设 |

### 5.2 验证方法

1. **色彩空间识别验证**
   - 加载已知色彩空间的图片
   - 检查检测到的色彩空间是否正确

2. **直方图准确性验证**
   - 使用标准色卡图片
   - 对比不同软件（Photoshop、Lightroom）的直方图

3. **视觉一致性验证**
   - 对比转换前后的颜色显示
   - 确保无明显偏色

## 6. 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|-----|-------|------|---------|
| ICC 解析错误 | 中 | 中 | 添加异常处理，失败时回退到 sRGB |
| 性能下降 | 低 | 中 | 缓存色彩空间检测结果 |
| 兼容性问题 | 低 | 高 | 保持默认行为不变，新功能可选启用 |

## 7. 相关文档

- [开发规范.md](./开发规范.md)
- [ICC 规范](https://www.color.org/icc_specs2.xhtml)
- [PIL Image 模块文档](https://pillow.readthedocs.io/en/stable/reference/Image.html)

---

**编写日期**: 2026-02-21  
**作者**: Color Card 开发团队
