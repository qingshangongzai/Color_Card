# Color Card 开发规范

## 1. 概述

### 1.1 项目简介

Color Card（取色卡）是一个基于 PySide6 开发的图片颜色分析工具，用于从图片中提取颜色信息和分析明度分布，支持多种色彩模式显示。

**核心功能：**
- 图片导入（JPG、PNG、BMP、GIF）
- 色彩提取：5个可拖动取色点，实时显示色彩值
- 多色彩模式：HSB、LAB、HSL、CMYK、RGB
- 明度提取与直方图可视化
- 双面板数据同步

### 1.2 开发环境

- **操作系统**：Windows 10/11
- **Python 版本**：3.11+
- **GUI 框架**：PySide6 + PySide6-Fluent-Widgets
- **推荐 IDE**：VS Code、PyCharm、Trae

### 1.3 项目结构

```
color_card/
├── main.py                 # 程序入口
├── version.py              # 版本管理模块
├── requirements.txt        # 项目依赖
├── README.md               # 项目文档
├── LICENSE                 # 开源许可证
├── 开发规范.md              # 本文件
├── core/                   # 核心功能模块目录
│   ├── __init__.py
│   ├── color.py           # 颜色处理模块（颜色转换、明度计算）
│   └── config.py          # 配置管理模块
├── ui/                     # UI模块目录（扁平化结构）
│   ├── __init__.py        # 统一导出接口
│   ├── main_window.py     # 主窗口类
│   ├── canvases.py        # 画布模块（BaseCanvas、ImageCanvas、LuminanceCanvas）
│   ├── cards.py           # 卡片组件模块（ColorCard、LuminanceCard）
│   ├── histograms.py      # 直方图组件模块
│   ├── color_picker.py    # 颜色选择器模块
│   ├── color_wheel.py     # 颜色轮模块
│   ├── zoom_viewer.py     # 缩放查看器模块
│   └── interfaces.py      # 界面面板模块
├── dialogs/               # 对话框模块目录
│   ├── __init__.py
│   ├── about_dialog.py    # 关于对话框
│   └── update_dialog.py   # 更新检查对话框
└── utils/                 # 工具函数模块目录
    ├── __init__.py
    ├── icon.py            # 图标工具模块
    └── platform.py        # 平台相关工具模块
```

---

## 2. 代码组织规范

### 2.1 文件命名规范

- 采用小写字母和下划线命名，如 `color_utils.py`
- 核心功能模块使用清晰的描述性名称
- 合并后的模块使用复数形式命名，如 `cards.py`、`histograms.py`、`canvases.py`

### 2.2 模块划分

| 模块类型 | 职责 | 示例文件 |
|:---:|:---:|:---:|
| 入口模块 | 应用程序入口 | `main.py` |
| 核心模块 | 颜色处理、配置管理 | `core/color.py`, `core/config.py` |
| UI 模块 | 界面组件和面板 | `ui/canvases.py`, `ui/cards.py` |
| 对话框模块 | 弹出对话框 | `dialogs/about_dialog.py` |
| 工具模块 | 通用功能 | `utils/icon.py`, `utils/platform.py` |

### 2.3 目录结构原则

**扁平化结构（2级目录）：**

```
color_card/           ← 第1级
├── core/            ← 第2级
├── ui/              ← 第2级（扁平化，直接包含所有UI文件）
├── dialogs/         ← 第2级
└── utils/           ← 第2级
```

**设计原则：**
- 避免过度嵌套（不超过2级目录）
- 将紧密相关的类合并到同一文件，减少文件数量
- 保持功能模块化，职责明确

### 2.4 导入规范

**导入顺序：** 标准库 → 第三方库 → 项目模块

**规范要求：**
- 按模块类型分组导入，添加清晰的分组注释
- 定期清理未使用的导入
- 合并同一模块的多次导入
- 优先使用绝对导入

```python
# 标准库导入
import sys
import math
from pathlib import Path

# 第三方库导入
from PySide6.QtWidgets import QApplication, QMainWindow
from PySide6.QtCore import Qt, Signal
from qfluentwidgets import FluentWindow

# 项目模块导入
from core import get_color_info, get_config_manager
from ui import MainWindow
```

**导入清理示例：**
```python
# 修改前
from styles import UnifiedStyleHelper
from styles import get_global_font_manager

# 修改后
from styles import UnifiedStyleHelper, get_global_font_manager
```

---

## 3. 代码编写规范

### 3.1 基本规范

- 遵循 **PEP 8** 代码风格规范
- 使用 4 个空格缩进
- 行长度限制在 100 字符以内
- 保持代码简洁，删除无用的调试代码和临时测试代码

### 3.2 代码清理原则

**修改代码时应同步进行以下清理：**
- 删除未使用的变量、函数、导入和注释
- 合并重复的逻辑和相似的功能
- 检查并清除相关的重复冗余代码
- 保持代码整洁，提高代码复用性

**清理示例：**
```python
# 修改前
import json
import re

def calculate():
    temp = 0  # 未使用的变量
    return result

# 修改后（删除未使用的导入和变量）
def calculate():
    return result
```

### 3.3 命名规范

| 类型 | 规范 | 示例 |
|:---:|:---:|:---:|
| 类名 | 驼峰命名法 | `ColorPicker`, `ImageCanvas` |
| 函数/方法 | 小写+下划线 | `extract_color()` |
| 变量 | 小写+下划线 | `picker_positions` |
| 常量 | 大写+下划线 | `PICKER_RADIUS = 12` |
| 私有属性 | 单下划线前缀 | `_dragging` |

### 3.4 异常处理规范

**基本原则：**
- 避免使用裸 `except:` 或 `except Exception:`
- 应指定具体异常类型
- 提供详细的错误信息，便于调试

**示例：**
```python
# 错误示例
except Exception:
    pass

# 正确示例
except (OSError, ValueError) as e:
    error_msg = f"文件读取失败: {str(e)}"
    print(error_msg)
```

### 3.5 文档字符串规范

**基本原则：**
- 所有公共类和方法必须添加文档字符串
- 使用简洁的中文描述，避免冗余
- 类文档字符串保持简洁（单行或简短段落）
- 方法文档字符串包含 Args、Returns 说明

**精简示例：**
```python
# 类文档字符串（简洁）
class ImageCanvas(QWidget):
    """图片显示画布，支持取色点拖动"""
    pass

# 方法文档字符串（完整但简洁）
def set_image(self, image_path):
    """加载并显示图片
    
    Args:
        image_path: 图片文件的完整路径
    """
    pass

# 带返回值的文档字符串
def get_color_info(self, r, g, b):
    """获取颜色信息
    
    Args:
        r: 红色通道值 (0-255)
        g: 绿色通道值 (0-255)
        b: 蓝色通道值 (0-255)
    
    Returns:
        dict: 包含RGB、HSB、LAB、HEX颜色信息的字典
    """
    pass
```

### 3.6 信号命名规范

- 信号名使用小写+下划线
- 添加注释说明信号参数

```python
class ImageCanvas(QWidget):
    color_picked = Signal(int, tuple)      # 信号：索引, RGB颜色
    image_loaded = Signal(str)              # 信号：图片路径
    image_cleared = Signal()                # 信号：图片已清空
```

---

## 4. 基类设计规范

### 4.1 画布基类 (BaseCanvas)

**文件位置：** `ui/canvases.py`

**职责：**
- 提供图片加载、显示的基础功能
- 实现坐标转换（画布坐标 ↔ 图片坐标）
- 管理图片相对坐标系统
- 提供右键菜单框架

**子类必须实现的方法：**
```python
def _on_image_loaded(self):
    """图片加载后的处理（子类重写）"""
    pass

def _on_image_cleared(self):
    """图片清空后的处理（子类重写）"""
    pass

def _draw_overlay(self, painter: QPainter):
    """绘制叠加内容（子类必须实现）"""
    raise NotImplementedError("子类必须实现 _draw_overlay 方法")
```

### 4.2 卡片基类 (BaseCard / BaseCardPanel)

**文件位置：** `ui/cards.py`

**职责：**
- 提供统一的卡片接口
- 管理卡片列表（BaseCardPanel）
- 支持批量清空卡片

**设计原则：**
- 保持接口简洁（setup_ui, clear）
- 灵活的卡片创建方法
- 清晰的职责分离

### 4.3 直方图基类 (BaseHistogram)

**文件位置：** `ui/histograms.py`

**职责：**
- 提供通用的数据管理（set_data, clear）
- 提供通用的绘制框架（paintEvent）
- 定义抽象方法接口

**子类必须实现的方法：**
```python
def _draw_histogram(self, painter: QPainter):
    """绘制直方图（子类必须实现）"""
    raise NotImplementedError("子类必须实现 _draw_histogram 方法")

def _draw_custom_overlay(self, painter: QPainter):
    """绘制自定义叠加内容（子类重写）"""
    pass

def _draw_labels(self, painter: QPainter):
    """绘制标签（子类重写）"""
    pass
```

### 4.4 基类设计原则

1. **单一职责**：每个基类只负责一类功能
2. **接口清晰**：抽象方法明确，子类职责清晰
3. **可扩展性**：便于添加新的子类实现
4. **代码复用**：提取公共逻辑，消除重复代码

---

## 5. PySide6 开发规范

### 5.1 Fluent Widgets 使用规范

- 主窗口继承 `FluentWindow`
- 使用 `setTheme()` 设置主题
- 使用 `setThemeColor()` 设置主题色

```python
from qfluentwidgets import FluentWindow, setTheme, Theme, FluentIcon

setTheme(Theme.AUTO)
setThemeColor('#0078d4')

class MainWindow(FluentWindow):
    def setup_navigation(self):
        self.addSubInterface(
            self.interface,
            FluentIcon.PALETTE,
            "界面名称"
        )
```

### 5.2 界面组织规范

- 每个功能模块创建独立的 `QWidget` 子类
- 界面类使用 `setObjectName()` 设置唯一标识

```python
class ColorExtractInterface(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setObjectName('colorExtractInterface')
        self.setup_ui()
        self.setup_connections()
```

### 5.3 信号与槽

- 信号连接应在初始化时完成
- 槽函数命名使用 `on_` 前缀

```python
# 信号连接
self.image_canvas.color_picked.connect(self.on_color_picked)

# 槽函数实现
def on_color_picked(self, index, rgb):
    """颜色提取回调"""
    pass
```

### 5.4 自定义控件规范

- 继承自合适的 QWidget 子类
- 重写 `paintEvent` 实现自定义绘制

```python
class ColorPicker(QWidget):
    """可拖动的圆形取色点"""
    
    def paintEvent(self, event):
        painter = QPainter(self)
        painter.setRenderHint(QPainter.RenderHint.Antialiasing)
        # 绘制代码...
```

### 5.5 样式设置规范

- 使用 `setTheme()` 设置全局主题
- **禁止使用硬编码颜色值**
- 使用 `isDarkTheme()` 检测当前主题

```python
from qfluentwidgets import isDarkTheme
from PySide6.QtGui import QColor

def get_text_color():
    """获取主题文本颜色"""
    return QColor(255, 255, 255) if isDarkTheme() else QColor(40, 40, 40)
```

### 5.6 右键菜单规范

- 使用 `RoundMenu` 创建 Fluent 风格的右键菜单
- 使用 `Action` 创建菜单项

```python
from qfluentwidgets import RoundMenu, Action, FluentIcon

def contextMenuEvent(self, event):
    menu = RoundMenu("")
    change_action = Action(FluentIcon.PHOTO, "更换图片")
    menu.addAction(change_action)
    menu.exec(event.globalPos())
```

---

## 6. 颜色处理规范

### 6.1 颜色空间转换

- 所有颜色转换函数放在 `core/color.py`
- 返回结果包含完整的颜色信息

```python
def get_color_info(r, g, b):
    """获取颜色的完整信息"""
    return {
        'rgb': (r, g, b),
        'hsb': (h, s, v),
        'lab': (l, a, b),
        'hex': rgb_to_hex(r, g, b)
    }
```

### 6.2 明度计算规范

使用 Rec. 709 标准计算亮度值，包含 sRGB Gamma 校正。

```python
def get_luminance(r: int, g: int, b: int) -> int:
    """计算像素的明度值 (0-255)
    
    使用 Rec. 709 标准计算亮度值，包含 sRGB Gamma 校正
    这是 Lightroom、Photoshop 等专业软件使用的标准方法
    """
    # 步骤1: 归一化到 0-1 范围
    r_norm, g_norm, b_norm = r / 255.0, g / 255.0, b / 255.0

    # 步骤2: sRGB Gamma 解码（转换到线性空间）
    def srgb_to_linear(c):
        if c <= 0.04045:
            return c / 12.92
        else:
            return ((c + 0.055) / 1.055) ** 2.4

    r_linear = srgb_to_linear(r_norm)
    g_linear = srgb_to_linear(g_norm)
    b_linear = srgb_to_linear(b_norm)

    # 步骤3: 在线性空间应用 Rec. 709 权重
    luminance_linear = 0.2126 * r_linear + 0.7152 * g_linear + 0.0722 * b_linear

    # 步骤4-5: 编码回 sRGB 空间并转换到 0-255
    # ...
```

### 6.3 Zone 分区规范

将 0-255 的明度值分为9个区域：

| Zone | 明度范围 | 描述 |
|:---:|:---:|:---:|
| Zone 0 | 0-28 | 极暗 |
| Zone 1 | 28-56 | 暗 |
| Zone 2 | 56-85 | 中暗 |
| Zone 3 | 85-113 | 次中暗 |
| Zone 4 | 113-141 | 中灰 |
| Zone 5 | 141-170 | 次中亮 |
| Zone 6 | 170-198 | 中亮 |
| Zone 7 | 198-227 | 亮 |
| Zone 8 | 227-255 | 极亮 |

---

## 7. 图片处理规范

### 7.1 图片加载规范

- 保留原始高分辨率图片
- 使用 `QPixmap` 用于显示，`QImage` 用于像素读取
- 使用多线程异步加载大图片

### 7.2 坐标映射规范

**核心原则：** 采样点位置使用**图片相对坐标**（归一化坐标 0.0-1.0）存储。

| 坐标类型 | 说明 | 范围 |
|:---:|:---|:---:|
| 相对坐标 | 相对于图片的归一化坐标 | 0.0-1.0 |
| 画布坐标 | 相对于画布控件的像素坐标 | 像素值 |

```python
# 相对坐标 → 画布坐标
canvas_x = disp_x + rel_x * disp_w

# 画布坐标 → 相对坐标
rel_x = (canvas_x - disp_x) / disp_w
```

### 7.3 性能优化规范

**基本策略：**
- 使用 `QThread` 在子线程读取图片文件
- 使用 `QTimer.singleShot()` 延迟执行耗时操作
- 直方图计算使用采样优化

**UI性能优化：**
- 批量更新UI时使用 `setUpdatesEnabled(False/True)` 包裹更新操作
- 避免在循环中频繁更新UI，先收集数据再批量更新
- 使用 `try-finally` 确保 `setUpdatesEnabled(True)` 一定会执行

```python
# 批量更新UI示例
def update_table_data(self):
    self.table.setUpdatesEnabled(False)
    try:
        for row in range(self.table.rowCount()):
            self.table.setItem(row, 0, item)
    finally:
        self.table.setUpdatesEnabled(True)
```

**数据结构优化：**
- 将列表转换为集合，将查找时间复杂度从 O(n) 降到 O(1)
- 缓存计算结果，避免重复计算和I/O操作
- 缓存应在数据变化时自动失效，确保数据一致性

---

## 8. 界面布局规范

### 8.1 布局原则

- 使用布局管理器（QVBoxLayout, QHBoxLayout）
- 避免使用固定尺寸，优先使用 size policy

### 8.2 控件尺寸参考

| 控件 | 推荐尺寸 | 说明 |
|:---:|:---:|:---:|
| 主窗口 | 940×660 | 默认尺寸 |
| 主窗口最小 | 800×550 | 保证内容完整显示 |
| 取色点半径 | 12px | 便于拖动操作 |

---

## 9. 交互设计规范

### 9.1 取色点交互

- 鼠标悬停：显示手型光标
- 拖动时：实时更新颜色值
- 边界限制：限制在图片显示区域内

### 9.2 快捷键规范

| 快捷键 | 功能 |
|:---:|:---:|
| Ctrl + O | 打开图片 |
| Ctrl + Q | 退出程序 |

---

## 10. 版本管理规范

### 10.1 版本号格式

- 格式：`主版本.次版本.修订版本`
- 示例：`1.0.0`
- 主版本：重大功能更新
- 次版本：新增功能
- 修订版本：bug 修复

### 10.2 提交信息规范

**格式：** `[类型] 详细描述`

**类型：**
- `新功能`：新增功能或特性
- `修复`：修复代码中的错误
- `优化`：性能或体验改进
- `重构`：代码结构调整
- `文档`：修改或新增文档
- `内容调整`：如替换链接、修改文本等

**示例：**
- `[新功能] 新增用户管理功能`
- `[修复] 修复登录功能的验证逻辑错误`
- `[重构] 提取 BaseCanvas 基类，消除重复代码`
- `[文档] 更新 README.md 和开发规范`

---

## 11. 配置管理规范

### 11.1 配置管理模块

使用 `core/config.py` 统一管理应用程序状态。

- 配置文件：JSON 格式，存储在用户主目录下的 `.color_card/config.json`
- 使用单例模式获取全局配置管理器实例

### 11.2 配置项说明

| 配置键 | 类型 | 默认值 | 说明 |
|:---:|:---:|:---:|:---|
| `settings.hex_visible` | bool | true | 是否显示16进制颜色值 |
| `settings.color_modes` | list | ["HSB", "LAB"] | 色卡中显示的色彩模式 |
| `settings.color_sample_count` | int | 5 | 色彩提取采样点数量 |
| `window.width` | int | 940 | 窗口宽度 |
| `window.height` | int | 660 | 窗口高度 |
| `window.is_maximized` | bool | false | 窗口是否最大化 |

### 11.3 使用示例

```python
from core import get_config_manager

config_manager = get_config_manager()
config = config_manager.load()

# 获取配置项
hex_visible = config_manager.get('settings.hex_visible', True)

# 设置配置项
config_manager.set('settings.hex_visible', False)
config_manager.save()
```

---

## 12. 调试规范

### 12.1 日志管理

**基本原则：**
- 使用 `print()` 语句进行调试（项目当前阶段）
- 关键操作应记录调试信息，便于调试和问题追踪

**说明：**
根据开发规范，本项目**保留 `print()` 调试语句**，原因如下：
1. 项目仍处于开发迭代阶段，后续功能修改需要调试支持
2. 调试语句有助于快速定位运行时问题
3. 方便其他开发者理解和调试代码
4. 开源发布时可根据需要决定是否保留（生产环境建议使用 `logging` 模块）

### 12.2 AI辅助调试

**日志查看流程：**
1. 应用程序启动失败时，查看控制台输出定位问题
2. 功能执行出现异常时，分析错误信息
3. 结合代码上下文，理解错误原因
4. 根据日志信息制定修复方案

---

## 13. 重构规范

### 13.1 重构原则

1. **保持功能不变**：重构过程中不改变现有功能
2. **渐进式重构**：分阶段进行，每阶段可独立验证
3. **先整理后重构**：先规范现有代码，再提取基类，最后重组目录
4. **代码清理同步**：修改代码时同步清理相关重复代码

### 13.2 基类提取规范

**步骤：**
1. 分析相似组件的公共逻辑
2. 设计基类接口（抽象方法）
3. 迁移第一个子类，验证基类设计
4. 迁移其他子类
5. 全面测试验证

**示例：**
```python
# 基类定义
class BaseCanvas(QWidget):
    def _draw_overlay(self, painter: QPainter):
        """绘制叠加内容（子类必须实现）"""
        raise NotImplementedError("子类必须实现 _draw_overlay 方法")

# 子类实现
class ImageCanvas(BaseCanvas):
    def _draw_overlay(self, painter: QPainter):
        """绘制取色点"""
        # 具体实现...
```

### 13.3 模块合并规范

**合并原则：**
- 将紧密相关的类合并到同一文件
- 避免过度拆分，提高代码可维护性
- 保持模块化，但减少文件数量

**示例：**
- `cards.py`：合并 ColorCard、LuminanceCard 及相关基类
- `histograms.py`：合并 LuminanceHistogramWidget、RGBHistogramWidget 及基类
- `canvases.py`：合并 BaseCanvas、ImageCanvas、LuminanceCanvas

---

## 14. 附录

### 14.1 扩展开发建议

**潜在功能扩展：**
- 导出颜色方案（JSON、CSS、ASE 等格式）
- 历史记录功能
- 配色规则检查
- 图片批量处理

**代码扩展原则：**
- 保持组件化设计
- 新功能应放在独立模块
- 使用信号槽进行组件通信

### 14.2 版本历史

| 版本 | 日期 | 变更内容 |
|:---:|:---:|:---|
| 3.2 | 2026-02-05 | 重构项目结构，提取公共基类（BaseCanvas、BaseCard、BaseHistogram），扁平化目录结构，更新文档 |
| 2.1 | 2026-02-04 | 借鉴BetterGI 星轨开发规范，新增导入规范、代码清理原则、异常处理规范、性能优化建议、调试规范 |
| 2.0 | 2026-02-04 | 重构文档结构，精简冗余内容，优化版本号体系 |
| 1.0 | 2026-02-03 | 初始版本，建立基础开发规范 |

---

**规范维护：** 本规范将根据项目发展进行更新，以适应新的功能需求和技术变化。
