# Color Extractor 开发规范

## 1. 概述

本规范旨在指导 Color Extractor 图片颜色提取器项目的后续开发，确保代码的一致性、可维护性和可扩展性。

### 1.1 项目简介

Color Extractor 是一个基于 PySide6 开发的 GUI 程序，用于从图片中提取颜色，显示 HSB 和 LAB 颜色值。核心功能包括：

- 图片导入（JPG、PNG、BMP、GIF）
- 5个可拖动取色点
- 实时颜色提取和显示
- HSB 和 LAB 双列显示

### 1.2 开发环境

- **操作系统**：Windows 10/11
- **Python 版本**：3.x
- **GUI 框架**：PySide6 + PySide6-Fluent-Widgets
- **推荐 IDE**：VS Code、PyCharm、Trae

### 1.3 项目结构

```
d:\青山公仔\应用\Py测试\取色卡\
├── main.py              # 程序入口
├── requirements.txt     # 项目依赖
├── color_utils.py       # 颜色转换工具（RGB ↔ HSB/LAB）
├── README.md            # 项目文档
├── 开发规范.md          # 本文件
└── widgets/
    ├── __init__.py      # 统一导出接口
    ├── main_window.py   # 主窗口（FluentWindow）
    ├── image_canvas.py  # 图片画布（核心组件）
    ├── color_picker.py  # 取色点组件
    ├── color_card.py    # 色卡面板
    └── zoom_viewer.py   # 放大视图组件（拖动时显示）
```

---

## 2. 代码组织规范

### 2.1 文件命名规范

- 采用小写字母和下划线命名，如 `color_utils.py`
- 核心功能模块使用清晰的描述性名称
- 组件文件应反映其功能，如 `color_picker.py`

### 2.2 模块划分

| 模块类型 | 职责 | 示例文件 |
|:---:|:---:|:---:|
| 入口模块 | 应用程序入口，初始化 QApplication | `main.py` |
| 工具模块 | 颜色空间转换等通用功能 | `color_utils.py` |
| 窗口模块 | 主窗口实现 | `main_window.py` |
| 画布模块 | 图片显示和取色点管理 | `image_canvas.py` |
| 组件模块 | 可复用的 UI 组件 | `color_picker.py`, `color_card.py` |

### 2.3 导入规范

- 按模块类型分组导入：标准库 → 第三方库 → 项目模块
- 使用绝对导入，保持清晰
- 避免循环导入

```python
# 标准库导入
import sys
import math

# 第三方库导入
from PySide6.QtWidgets import QApplication, QMainWindow
from PySide6.QtCore import Qt, Signal
from PySide6.QtGui import QPainter, QColor
from qfluentwidgets import FluentWindow, setTheme, Theme, setThemeColor, FluentIcon

# 项目模块导入
from widgets import MainWindow
from color_utils import get_color_info
```

---

## 3. 代码编写规范

### 3.1 基本规范

- 遵循 **PEP 8** 代码风格规范
- 使用 4 个空格缩进
- 行长度限制在 100 字符以内
- 使用清晰、有意义的变量和函数命名

### 3.2 命名规范

| 类型 | 规范 | 示例 |
|:---:|:---:|:---:|
| 类名 | 驼峰命名法 (CamelCase) | `ColorPicker`, `ImageCanvas` |
| 函数/方法 | 小写+下划线 | `extract_color()`, `update_picker_positions()` |
| 变量 | 小写+下划线 | `picker_positions`, `original_pixmap` |
| 常量 | 大写+下划线 | `PICKER_RADIUS = 12` |
| 私有属性 | 单下划线前缀 | `_dragging`, `_color` |

### 3.3 文档字符串规范

- 所有公共类和方法必须添加文档字符串
- 使用简洁的中文描述
- 复杂逻辑添加行内注释

```python
def rgb_to_hsb(r, g, b):
    """将RGB转换为HSB (Hue, Saturation, Brightness)"""
    # 归一化到 0-1 范围
    r, g, b = r / 255.0, g / 255.0, b / 255.0
    h, s, v = colorsys.rgb_to_hsv(r, g, b)
    return h * 360, s * 100, v * 100


class ImageCanvas(QWidget):
    """图片显示画布，支持取色点拖动"""
    
    color_picked = pyqtSignal(int, tuple)  # 信号：索引, RGB颜色
    
    def set_image(self, image_path):
        """加载并显示图片
        
        Args:
            image_path: 图片文件的完整路径
        """
        # 实现代码...
```

### 3.4 信号命名规范

- 信号名使用小写+下划线
- 信号名应描述动作或状态变化
- 添加注释说明信号参数

```python
class ImageCanvas(QWidget):
    color_picked = pyqtSignal(int, tuple)      # 信号：索引, RGB颜色
    image_loaded = pyqtSignal(str)              # 信号：图片路径
    position_changed = pyqtSignal(int, QPoint)  # 信号：索引, 新位置
```

---

## 4. PyQt6 开发规范

### 4.1 PySide6-Fluent-Widgets 使用规范

- 主窗口继承 `FluentWindow` 而非 `QMainWindow`
- 使用 `setTheme()` 设置主题（Theme.AUTO / Theme.LIGHT / Theme.DARK）
- 使用 `setThemeColor()` 设置主题色
- 使用 `addSubInterface()` 添加导航界面
- 使用 `qrouter` 管理页面路由

```python
from qfluentwidgets import FluentWindow, setTheme, Theme, setThemeColor, FluentIcon, NavigationItemPosition, qrouter

# 设置主题
setTheme(Theme.AUTO)
setThemeColor('#0078d4')

# 创建主窗口
class MainWindow(FluentWindow):
    def __init__(self):
        super().__init__()
        self.create_sub_interface()
        self.setup_navigation()
    
    def create_sub_interface(self):
        """创建子界面"""
        self.interface = QWidget()
        self.interface.setObjectName('interface')
        self.stackedWidget.addWidget(self.interface)
    
    def setup_navigation(self):
        """设置导航栏"""
        self.addSubInterface(
            self.interface,
            FluentIcon.PALETTE,
            "界面名称",
            position=NavigationItemPosition.TOP
        )
```

### 4.2 界面组织规范

- 每个功能模块创建独立的 `QWidget` 子类作为界面
- 界面类使用 `setObjectName()` 设置唯一标识
- 将界面添加到 `stackedWidget` 中
- 使用 `qrouter.setDefaultRouteKey()` 设置默认路由

```python
class ColorExtractInterface(QWidget):
    """色彩提取界面"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setup_ui()
        self.setup_connections()
    
    def setup_ui(self):
        """设置界面布局"""
        layout = QVBoxLayout(self)
        # 添加控件...
    
    def setup_connections(self):
        """设置信号连接"""
        # 连接信号...
```

### 4.3 信号与槽

- 使用 `Signal` 定义信号
- 信号连接应在初始化时完成
- 槽函数命名使用 `on_` 前缀

```python
# 信号定义
class ImageCanvas(QWidget):
    color_picked = Signal(int, tuple)
```
# 信号连接
self.image_canvas.color_picked.connect(self.on_color_picked)

# 槽函数实现
def on_color_picked(self, index, rgb):
    """颜色提取回调"""
    color_info = get_color_info(*rgb)
    self.color_card_panel.update_color(index, color_info)
```

### 4.4 自定义控件规范

- 继承自合适的 QWidget 子类
- 重写 `paintEvent` 实现自定义绘制
- 重写鼠标事件实现交互

```python
class ColorPicker(QWidget):
    """可拖动的圆形取色点"""
    
    def __init__(self, index, parent=None):
        super().__init__(parent)
        self.index = index
        self.radius = 12
        self.setFixedSize(self.radius * 2, self.radius * 2)
    
    def paintEvent(self, event):
        """绘制取色点"""
        painter = QPainter(self)
        painter.setRenderHint(QPainter.RenderHint.Antialiasing)
        # 绘制代码...
    
    def mousePressEvent(self, event):
        """鼠标按下事件"""
        if event.button() == Qt.MouseButton.LeftButton:
            self._dragging = True
            event.accept()
```

### 4.5 样式设置规范

- 使用 `setTheme()` 设置全局主题，避免手动设置样式表
- 使用 `setThemeColor()` 设置主题色，保持界面风格统一
- 特殊控件需要自定义样式时，使用 Fluent 风格的设计规范
- 避免使用 QSS 样式表，优先使用 Fluent 组件

```python
# 设置全局主题
setTheme(Theme.AUTO)
setThemeColor('#0078d4')

# 特殊控件样式（仅在必要时使用）
self.setStyleSheet("background-color: #2a2a2a; border-radius: 8px;")
```

### 4.6 右键菜单规范

- 使用 `RoundMenu` 创建 Fluent 风格的右键菜单
- 使用 `Action` 创建菜单项，支持 Fluent 图标
- 菜单标题使用空字符串 `""` 而非父组件
- 右键菜单仅在适当场景下显示（如已加载图片时）

```python
from qfluentwidgets import RoundMenu, Action, FluentIcon

def contextMenuEvent(self, event):
    """右键菜单事件"""
    # 只有在满足条件时才显示右键菜单
    if not self.should_show_menu():
        return

    # 创建菜单，标题参数为空字符串
    menu = RoundMenu("")

    # 添加带图标的菜单项
    change_action = Action(FluentIcon.PHOTO, "更换图片")
    change_action.triggered.connect(self.change_image_requested.emit)
    menu.addAction(change_action)

    clear_action = Action(FluentIcon.DELETE, "清空图片")
    clear_action.triggered.connect(self.clear_image_requested.emit)
    menu.addAction(clear_action)

    # 在鼠标位置显示菜单
    menu.exec(event.globalPos())
```

---

## 5. 颜色处理规范

### 5.1 颜色空间转换

- 所有颜色转换函数放在 `color_utils.py`
- 使用标准算法进行颜色空间转换
- 返回结果应包含完整的颜色信息

```python
def get_color_info(r, g, b):
    """获取颜色的完整信息"""
    h, s, b_val = rgb_to_hsb(r, g, b)
    l, a, b_lab = rgb_to_lab(r, g, b)

    return {
        'rgb': (r, g, b),
        'hsb': (round(h), round(s), round(b_val)),
        'lab': (round(l), round(a), round(b_lab))
    }
```

### 5.2 颜色值显示规范

- HSB 值：H 显示为度(°)，S/B 显示为百分比(%)
- LAB 值：直接显示数值
- RGB 值：用于颜色块显示

---

## 6. 图片处理规范

### 6.1 图片加载规范

- 保留原始高分辨率图片
- 使用 `QPixmap` 用于显示
- 使用 `QImage` 用于像素读取

```python
def set_image(self, image_path):
    """加载并显示图片"""
    # 加载原始高分辨率图片
    self._original_pixmap = QPixmap(image_path)
    self._image = QImage(image_path)
```

### 6.2 坐标映射规范

- 显示坐标 → 原始图片坐标的映射
- 使用比例计算确保精度
- 边界检查防止越界

```python
# 将画布坐标转换为图片坐标
img_x = pos.x() - disp_x
img_y = pos.y() - disp_y

# 计算在原始图片中的坐标
scale_x = self._image.width() / disp_w
scale_y = self._image.height() / disp_h
orig_x = int(img_x * scale_x)
orig_y = int(img_y * scale_y)

# 边界检查
orig_x = max(0, min(orig_x, self._image.width() - 1))
orig_y = max(0, min(orig_y, self._image.height() - 1))
```

---

## 7. 界面布局规范

### 7.1 布局原则

- 使用布局管理器（QVBoxLayout, QHBoxLayout）
- 避免使用固定尺寸，优先使用 size policy
- 合理使用 stretch 分配空间

### 7.2 分割器使用

- 使用 QSplitter 实现可调节区域
- 设置合理的初始分割比例
- 设置最小尺寸限制

```python
splitter = QSplitter(Qt.Orientation.Vertical)
splitter.addWidget(self.image_canvas)
splitter.addWidget(self.color_card_panel)
splitter.setSizes([500, 200])
```

### 7.3 控件尺寸规范

| 控件 | 推荐尺寸 | 说明 |
|:---:|:---:|:---:|
| 主窗口 | 1200×800 | 默认尺寸，可调整 |
| 主窗口最小 | 1000×700 | 保证内容完整显示 |
| 色卡面板最大高度 | 280px | 防止占用过多空间 |
| 取色点半径 | 12px | 便于拖动操作 |
| 颜色块高度 | 80px | 清晰展示颜色 |

---

## 8. 交互设计规范

### 8.1 取色点交互

- 鼠标悬停：显示手型光标
- 鼠标按下：显示抓取光标，高亮显示
- 拖动时：实时更新颜色值
- 边界限制：限制在画布范围内

### 8.2 图片导入交互

- 无图片时：显示提示文字，点击打开文件对话框
- 有图片时：显示图片和取色点
- 支持菜单栏和快捷键导入

### 8.3 快捷键规范

| 快捷键 | 功能 |
|:---:|:---:|
| Ctrl + O | 打开图片 |
| Ctrl + Q | 退出程序 |

---

## 9. 代码修改规范

### 9.1 修改原则

- 小步修改，每次专注于一个功能点
- 保持向后兼容
- 修改前备份或使用版本控制
- 修改后测试验证

### 9.2 新增功能规范

1. **需求分析**：明确功能需求和实现方案
2. **设计**：设计接口和交互方式
3. **实现**：编写代码，遵循本规范
4. **测试**：验证功能正确性
5. **文档**：更新 README 和文档字符串

### 9.3 代码清理

- 删除未使用的导入
- 删除未使用的变量和函数
- 合并重复逻辑
- 保持代码简洁

---

## 10. 版本管理规范

### 10.1 版本号格式

- 格式：`主版本.次版本.修订版本`
- 示例：`1.0.0`
- 主版本：重大功能更新
- 次版本：新增功能
- 修订版本：bug 修复

### 10.2 提交信息规范

#### 10.2.1 日常提交格式

- 提交信息应清晰、简洁，描述本次提交的主要内容
- 提交信息标题格式：`[类型] 详细描述`
- 类型包括：
  - `新功能`：新增功能或特性
  - `修复bug`：修复代码中的错误
  - `内容调整`：如替换链接、修改文本等
  - `文档更新`：修改或新增文档
  - `样式修改`：代码样式调整，不影响功能
  - `重构`：代码结构调整，不影响功能
  - `优化`：在不改变功能的前提下，提升代码或系统的性能、效率或用户体验的改进
  - `测试`：新增或修改测试代码
  - `构建变更`：修改依赖、构建脚本等
  - `配置变更`：修改配置文件

#### 10.2.2 Pull Request提交格式

Pull Request提交分为两种情况：日常修改/调整和版本更新。

##### 10.2.2.1 日常修改/调整（提交到Dev分支）

- 适用场景：日常调整、增加新功能、修复bug等
- 所有日常修改和调整都直接提交到Dev分支
- Pull Request标题格式：`[类型] 详细描述`
- Pull Request正文应包含：
  - 修改内容的详细描述
  - 修改的理由和目的
  - 测试情况
  - 相关Issue或参考链接（如果有）
- 无需包含开发者署名，Pull Request会自动记录创建者信息

##### 10.2.2.2 版本更新（合并到主分支）

- 适用场景：一次性合并很多内容到主分支，进行版本发布
- 由项目维护者执行，从Dev分支合并到主分支
- Pull Request标题格式：直接使用版本号，如 `1.5.0`
- Pull Request正文格式：`[类型] 详细描述`
- Pull Request正文应包含：
  - 版本更新的主要内容和变更
  - 新增功能列表
  - 修复的bug列表
- Pull Request需包含开发者署名

#### 10.2.3 提交信息示例

1. **日常提交示例**：
   - `[内容调整] 将关于页面的项目地址按钮从GitHub替换为Gitee`
   - `[修复bug] 修复登录功能的验证逻辑错误`
   - `[新功能] 新增用户管理功能`
   - `[文档更新] 更新README.md中的安装指南`

2. **Pull Request示例**：

   ##### 2.1 日常修改/调整（提交到Dev分支）
   - 标题：`[内容调整] 将关于页面的项目地址按钮从GitHub替换为Gitee`
   - 正文：

     ```
     修改内容：将关于页面的项目地址按钮从GitHub替换为Gitee
     修改理由：考虑到国内用户访问Gitee更稳定
     测试情况：已在本地测试，功能正常
     相关Issue：无
     ```

   ##### 2.2 版本更新（合并到主分支）
   - 标题：`1.5.0`
   - 正文：

     ```
     【修复bug】修复了取色点拖动时坐标计算错误的问题；
     【修复bug】修复了高DPI屏幕下图标显示模糊的bug；
     【新功能】新增颜色导出功能，支持JSON和CSS格式；
     【样式修改】优化了色卡面板的布局；
     【文档更新】更新了使用说明和开发规范。
     ```

---

## 11. 调试规范

### 11.1 日志输出

- 使用 print 或 logging 输出调试信息
- 关键操作添加日志
- 异常捕获并输出错误信息

### 11.2 常见问题排查

| 问题 | 排查方法 |
|:---:|:---:|
| 图片无法加载 | 检查文件路径和格式 |
| 取色点无法拖动 | 检查事件处理和坐标计算 |
| 颜色值不正确 | 检查坐标映射和颜色转换 |
| 界面显示异常 | 检查样式表和布局设置 |

---

## 12. 扩展开发建议

### 12.1 潜在功能扩展

- 导出颜色方案（JSON、CSS、ASE 等格式）
- 历史记录功能
- 配色规则检查（对比度、色相等）
- 更多颜色空间支持（CMYK、Pantone 等）
- 图片批量处理

### 12.2 代码扩展原则

- 保持组件化设计
- 新功能应放在独立模块
- 使用信号槽进行组件通信
- 保持向后兼容

---

## 13. 总结

本规范基于 Color Extractor 项目的现有代码结构制定，旨在确保代码的一致性、可维护性和可扩展性。所有开发者应遵循本规范进行开发。

规范将根据项目发展进行更新，以适应新的功能需求和技术变化。

---

## 版本历史

| 版本 | 日期 | 变更内容 |
|:---:|:---:|:---:|
| 2.4 | 2026-02-03 | 更新提交信息规范，添加 Pull Request 提交格式和详细示例 |
| 2.3 | 2026-02-03 | 添加 zoom_viewer 组件规范，支持拖动时放大显示 |
| 2.2 | 2026-02-03 | 添加右键菜单规范（RoundMenu、Action 使用规范） |
| 2.1 | 2026-02-03 | 将 PyQt6 替换为 PySide6 |
| 2.0 | 2026-02-03 | 更新为基于 PySide6-Fluent-Widgets 的开发规范 |
| 1.0 | 2026-02-03 | 初始版本，基于项目现有代码结构制定 |
