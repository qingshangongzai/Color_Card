name: Build Mac App

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    - name: Read version
      id: version
      run: |
        VERSION=$(head -n 1 version.txt | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        echo "Debug: version content is: '$VERSION'"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
    
    - name: Build Mac App with PyInstaller
      run: |
        pyinstaller \
          --name "ColorCard" \
          --windowed \
          --onefile \
          --add-data "version.py:." \
          --add-data "core:core" \
          --add-data "dialogs:dialogs" \
          --add-data "file:file" \
          --add-data "logo:logo" \
          --add-data "ui:ui" \
          --add-data "utils:utils" \
          --add-data "locales:locales" \
          --add-data "color_data:color_data" \
          --add-data "scenes_data:scenes_data" \
          --exclude-module "PySide6.Qt3DAnimation" \
          --exclude-module "PySide6.Qt3DCore" \
          --exclude-module "PySide6.Qt3DExtras" \
          --exclude-module "PySide6.Qt3DInput" \
          --exclude-module "PySide6.Qt3DLogic" \
          --exclude-module "PySide6.Qt3DRender" \
          --exclude-module "PySide6.QtCharts" \
          --exclude-module "PySide6.QtDataVisualization" \
          --exclude-module "PySide6.QtGraphs" \
          --exclude-module "PySide6.QtLocation" \
          --exclude-module "PySide6.QtMultimedia" \
          --exclude-module "PySide6.QtMultimediaWidgets" \
          --exclude-module "PySide6.QtNetworkAuth" \
          --exclude-module "PySide6.QtPositioning" \
          --exclude-module "PySide6.QtQuick" \
          --exclude-module "PySide6.QtQuick3D" \
          --exclude-module "PySide6.QtQuickWidgets" \
          --exclude-module "PySide6.QtRemoteObjects" \
          --exclude-module "PySide6.QtSensors" \
          --exclude-module "PySide6.QtSerialBus" \
          --exclude-module "PySide6.QtSerialPort" \
          --exclude-module "PySide6.QtSql" \
          --exclude-module "PySide6.QtStateMachine" \
          --exclude-module "PySide6.QtTest" \
          --exclude-module "PySide6.QtTextToSpeech" \
          --exclude-module "PySide6.QtWebChannel" \
          --exclude-module "PySide6.QtWebEngineCore" \
          --exclude-module "PySide6.QtWebEngineQuick" \
          --exclude-module "PySide6.QtWebEngineWidgets" \
          --exclude-module "PySide6.QtWebSockets" \
          --exclude-module "PySide6.QtXmlPatterns" \
          --exclude-module "PySide6.QtOpenGL" \
          --exclude-module "PySide6.QtOpenGLWidgets" \
          --exclude-module "PySide6.QtPdf" \
          --exclude-module "PySide6.QtPdfWidgets" \
          --exclude-module "PySide6.QtConcurrent" \
          --exclude-module "PySide6.QtHelp" \
          --exclude-module "unittest" \
          --exclude-module "pydoc" \
          --exclude-module "doctest" \
          --exclude-module "test" \
          --exclude-module "matplotlib" \
          --exclude-module "pandas" \
          --exclude-module "scipy" \
          --exclude-module "sklearn" \
          --exclude-module "cv2" \
          --exclude-module "tkinter" \
          --exclude-module "_tkinter" \
          --osx-bundle-identifier "com.hxiaostudio.colorcard" \
          --clean \
          main.py
    
    - name: Check build output
      run: |
        echo "Checking dist directory..."
        ls -la dist/
        echo "Checking if ColorCard exists..."
        ls -la dist/ColorCard || echo "ColorCard not found"
    
    - name: Create DMG
      run: |
        # 创建临时目录结构
        mkdir -p dist/dmg/ColorCard.app/Contents/MacOS
        mkdir -p dist/dmg/ColorCard.app/Contents/Resources
        
        # 复制可执行文件
        cp dist/ColorCard dist/dmg/ColorCard.app/Contents/MacOS/
        
        # 创建 Info.plist
        cat > dist/dmg/ColorCard.app/Contents/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>ColorCard</string>
            <key>CFBundleIdentifier</key>
            <string>com.hxiaostudio.colorcard</string>
            <key>CFBundleName</key>
            <string>ColorCard</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.14</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # 创建 DMG
        hdiutil create -volname "ColorCard" -srcfolder dist/dmg -ov -format UDZO dist/ColorCard-${{ steps.version.outputs.version }}-macOS.dmg
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ColorCard-macOS
        path: |
          dist/ColorCard-*.dmg
          dist/ColorCard
    
    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/ColorCard-*.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
